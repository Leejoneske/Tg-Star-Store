<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarStore - Transaction History</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f5f7fa;
        }
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            min-height: 100vh;
            position: relative;
        }
        .header {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: white;
            padding: 20px;
            border-radius: 0 0 20px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }
        .tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .transaction-card {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            overflow: hidden;
        }
        .transaction-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }
        .status-badge {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 20px;
            font-weight: 500;
        }
        .status-completed {
            background: #ecfdf5;
            color: #059669;
        }
        .status-pending {
            background: #fffbeb;
            color: #d97706;
        }
        .status-declined {
            background: #fef2f2;
            color: #dc2626;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 70%;
            max-width: 300px;
            height: 100%;
            background: white;
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(3px);
        }
        .overlay.open {
            opacity: 1;
            visibility: visible;
        }
                .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .side-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 64%;
            height: 100%;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 50;
            transition: all 0.3s ease;
        }
        .side-menu.active {
            left: 0;
        }
        .menu-item {
            padding: 12px 16px;
            font-size: 16px;
            color: #4f46e5;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        .menu-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .chart-container {
            position: relative;
            height: 220px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #6b7280;
        }
        .empty-state svg {
            width: 80px;
            height: 80px;
            color: #d1d5db;
            margin-bottom: 16px;
        }
        .pagination-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .pagination-btn.active {
            background: #4f46e5;
            color: white;
        }
        .filter-active {
            background: #eef2ff;
            color: #4f46e5;
            border-color: #4f46e5;
        }
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .shimmer {
            position: relative;
            overflow: hidden;
        }
        .shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.2) 20%, 
                rgba(255,255,255,0.5) 60%, 
                rgba(255,255,255,0) 100%);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
        <div class="side-menu" id="sideMenu">
            <div class="p-6">
                <div class="text-xl font-bold mb-8" data-lang="menu">Menu</div>
                <nav class="space-y-2">
                    <a href="index.html" class="menu-item">
                        <img src="https://cdn.glitch.global/3dc16b91-13ae-417c-bfeb-45232e6f0f9f/house.png?v=1740035666721/40" alt="Home Icon" class="w-5 h-5">
                        <span data-lang="home">Home</span>
                    </a>
                    <a href="sell.html" class="menu-item">
                        <img src="https://cdn.glitch.global/3dc16b91-13ae-417c-bfeb-45232e6f0f9f/save-money.png?v=1740035327199/40" alt="Sell Icon" class="w-5 h-5">
                        <span data-lang="sell">Sell</span>
                    </a>
                    <a href="history.html" class="menu-item">
                        <img src="https://cdn.glitch.global/3dc16b91-13ae-417c-bfeb-45232e6f0f9f/parchment.png?v=1740035762624/40" alt="History Icon" class="w-5 h-5">
                        <span data-lang="history">History</span>
                    </a>
                    <a href="referral.html" class="menu-item">
                        <img src="https://cdn.glitch.global/3dc16b91-13ae-417c-bfeb-45232e6f0f9f/referral.png?v=1740035816288/40" alt="Referral Icon" class="w-5 h-5">
                        <span data-lang="referral">Referral</span>
                    </a>
                    <a href="about.html" class="menu-item">
                        <img src="https://cdn.glitch.global/3dc16b91-13ae-417c-bfeb-45232e6f0f9f/about.png?v=1740035453130/40" alt="About Icon" class="w-5 h-5">
                        <span data-lang="about">About</span>
                    </a>
                </nav>
            </div>
        </div>
        
        <!-- Header -->
        <div class="header">
            <div class="flex justify-between items-center mb-6">
                <button id="menuBtn" class="p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="text-xl font-bold">StarStore</div>
                <div class="w-8"></div>
            </div>
            <h1 class="text-2xl font-bold mb-2" data-i18n="activity_history">Activity History</h1>
            <p class="text-indigo-100" data-i18n="history_description">Track all your transactions and referrals in one place</p>
        </div>
        
        <!-- Main Content -->
        <div class="px-4">
            <!-- Tabs -->
            <div class="flex border-b mb-6">
                <button id="transactionsTab" class="flex-1 py-3 text-center tab-active" data-i18n="transactions">
                    Transactions
                </button>
                <button id="referralsTab" class="flex-1 py-3 text-center" data-i18n="referrals">
                    Referrals
                </button>
            </div>
            
            <!-- Transactions Tab Content -->
            <div id="transactionsContent" class="tab-content active">
                <!-- Overview Card -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-4" data-i18n="overview">Overview</h3>
                    <div class="chart-container">
                        <canvas id="transactionChart"></canvas>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mt-4">
                        <div class="text-center p-2 rounded-lg bg-green-50">
                            <div class="text-green-600 text-xl font-semibold" id="completedCount">0</div>
                            <div class="text-xs text-green-800" data-i18n="completed">Completed</div>
                        </div>
                        <div class="text-center p-2 rounded-lg bg-yellow-50">
                            <div class="text-yellow-600 text-xl font-semibold" id="pendingCount">0</div>
                            <div class="text-xs text-yellow-800" data-i18n="pending">Pending</div>
                        </div>
                        <div class="text-center p-2 rounded-lg bg-red-50">
                            <div class="text-red-600 text-xl font-semibold" id="declinedCount">0</div>
                            <div class="text-xs text-red-800" data-i18n="declined">Declined</div>
                        </div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="flex mb-4 space-x-2 overflow-x-auto pb-2 scrollbar-hide">
                    <button class="filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap filter-active" data-filter="all" data-i18n="all">All</button>
                    <button class="filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap" data-filter="completed" data-i18n="completed">Completed</button>
                    <button class="filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap" data-filter="pending" data-i18n="pending">Pending</button>
                    <button class="filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap" data-filter="declined" data-i18n="declined">Declined</button>
                </div>
                
                <!-- Search -->
                <div class="relative mb-6">
                    <input type="text" id="searchTransactions" class="w-full p-3 pl-10 pr-4 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" data-i18n-placeholder="search_transactions" placeholder="Search transactions...">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                </div>
                
                <!-- Transactions List -->
                <div id="transactionsLoading" class="space-y-4 mb-6">
                    <div class="skeleton h-20 rounded-xl shimmer"></div>
                    <div class="skeleton h-20 rounded-xl shimmer"></div>
                    <div class="skeleton h-20 rounded-xl shimmer"></div>
                </div>
                
                <div id="transactionsList" class="space-y-4 mb-6" style="display:none"></div>
                
                <div id="transactionsEmpty" class="empty-state" style="display:none">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <p class="text-center" data-i18n="no_transactions">No transactions found</p>
                </div>
                
                <!-- Pagination -->
                <div id="transactionsPagination" class="flex justify-center items-center gap-2 mb-6"></div>
                
                <!-- Export Button -->
                <button id="exportTransactions" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors mb-8 flex justify-center items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <span data-i18n="export_transactions">Export Transactions</span>
                </button>
            </div>
            
            <!-- Referrals Tab Content -->
            <div id="referralsContent" class="tab-content">
                <!-- Filters -->
                <div class="flex mb-4 space-x-2 overflow-x-auto pb-2 scrollbar-hide">
                    <button class="ref-filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap filter-active" data-filter="all" data-i18n="all">All</button>
                    <button class="ref-filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap" data-filter="active" data-i18n="active">Active</button>
                    <button class="ref-filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap" data-filter="pending" data-i18n="pending">Pending</button>
                </div>
                
                <!-- Search -->
                <div class="relative mb-6">
                    <input type="text" id="searchReferrals" class="w-full p-3 pl-10 pr-4 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" data-i18n-placeholder="search_referrals" placeholder="Search referrals...">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                </div>
                
                <!-- Referrals List -->
                <div id="referralsLoading" class="space-y-4 mb-6">
                    <div class="skeleton h-20 rounded-xl shimmer"></div>
                    <div class="skeleton h-20 rounded-xl shimmer"></div>
                    <div class="skeleton h-20 rounded-xl shimmer"></div>
                </div>
                
                <div id="referralsList" class="space-y-4 mb-6" style="display:none"></div>
                
                <div id="referralsEmpty" class="empty-state" style="display:none">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <p class="text-center" data-i18n="no_referrals">No referrals found</p>
                </div>
                
                <!-- Pagination -->
                <div id="referralsPagination" class="flex justify-center items-center gap-2 mb-6"></div>
                
                <!-- Export Button -->
                <button id="exportReferrals" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors mb-8 flex justify-center items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <span data-i18n="export_referrals">Export Referrals</span>
                </button>
            </div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
// Initialize Telegram WebApp
Telegram.WebApp.ready();
const user = Telegram.WebApp.initDataUnsafe.user;

// App state
let transactionHistory = [];
let referralHistory = [];
let currentTransactionPage = 1;
let currentReferralPage = 1;
let currentTransactionFilter = 'all';
let currentReferralFilter = 'all';
let currentTransactionSearch = '';
let currentReferralSearch = '';
const itemsPerPage = 5;
let currentLanguage = localStorage.getItem('appLanguage') || 'en';
let transactionChart = null;

// Language translations
const translations = {
    en: {
        menu: "Menu",
        home: "Home",
        sell: "Sell",
        history: "History",
        referral: "Referral",
        about: "About",
        activity_history: "Activity History",
        history_description: "Track all your transactions and referrals in one place",
        transactions: "Transactions",
        referrals: "Referrals",
        overview: "Overview",
        all: "All",
        completed: "Completed",
        pending: "Pending",
        declined: "Declined",
        active: "Active",
        search_transactions: "Search transactions...",
        search_referrals: "Search referrals...",
        no_transactions: "No transactions found",
        no_referrals: "No referrals found",
        export_transactions: "Export Transactions",
        export_referrals: "Export Referrals",
        transaction_details: "Transaction Details",
        referral_details: "Referral Details",
        id: "ID",
        type: "Type",
        amount: "Amount",
        status: "Status",
        date: "Date",
        name: "Name",
        today: "Today",
        yesterday: "Yesterday",
        days_ago: "days ago",
        total: "Total",
        view_details: "View Details",
        language: "Language",
        stars_purchase: "Stars Purchase",
        close: "Close"
    },
    ru: {
        menu: "Меню",
        home: "Главная",
        sell: "Продать",
        history: "История",
        referral: "Рефералы",
        about: "О нас",
        activity_history: "История активности",
        history_description: "Отслеживайте все ваши транзакции и рефералы в одном месте",
        transactions: "Транзакции",
        referrals: "Рефералы",
        overview: "Обзор",
        all: "Все",
        completed: "Завершено",
        pending: "В ожидании",
        declined: "Отклонено",
        active: "Активно",
        search_transactions: "Поиск транзакций...",
        search_referrals: "Поиск рефералов...",
        no_transactions: "Транзакций не найдено",
        no_referrals: "Рефералов не найдено",
        export_transactions: "Экспорт транзакций",
        export_referrals: "Экспорт рефералов",
        transaction_details: "Детали транзакции",
        referral_details: "Детали реферала",
        id: "ID",
        type: "Тип",
        amount: "Сумма",
        status: "Статус",
        date: "Дата",
        name: "Имя",
        today: "Сегодня",
        yesterday: "Вчера",
        days_ago: "дней назад",
        total: "Всего",
        view_details: "Просмотр деталей",
        language: "Язык",
        stars_purchase: "Покупка звезд",
        close: "Закрыть"
    }
};

// App initialization
document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

function initApp() {
    // Set language
    document.getElementById('languageSelector').value = currentLanguage;
    updateLanguage();
    
    // Initialize event listeners
    setupEventListeners();
    
    // Load data
    loadTransactionHistory();
    loadReferralHistory();
    
    // Listen for language changes from storage
    window.addEventListener('storage', (event) => {
        if (event.key === 'appLanguage') {
            currentLanguage = event.newValue || 'en';
            updateLanguage();
        }
    });
}

function setupEventListeners() {
    // Menu toggle
    document.getElementById('menuBtn').addEventListener('click', toggleMenu);
    document.getElementById('closeMenu').addEventListener('click', toggleMenu);
    document.getElementById('overlay').addEventListener('click', toggleMenu);
    
    // Tab switching
    document.getElementById('transactionsTab').addEventListener('click', () => switchTab('transactions'));
    document.getElementById('referralsTab').addEventListener('click', () => switchTab('referrals'));
    
    // Language selector
    document.getElementById('languageSelector').addEventListener('change', (e) => {
        currentLanguage = e.target.value;
        localStorage.setItem('appLanguage', currentLanguage);
        updateLanguage();
    });
    
    // Transaction filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const filter = btn.getAttribute('data-filter');
            currentTransactionFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('filter-active'));
            btn.classList.add('filter-active');
            currentTransactionPage = 1;
            updateTransactionList();
        });
    });
    
    // Referral filters
    document.querySelectorAll('.ref-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const filter = btn.getAttribute('data-filter');
            currentReferralFilter = filter;
            document.querySelectorAll('.ref-filter-btn').forEach(b => b.classList.remove('filter-active'));
            btn.classList.add('filter-active');
            currentReferralPage = 1;
            updateReferralList();
        });
    });
    
    // Search inputs
    document.getElementById('searchTransactions').addEventListener('input', (e) => {
        currentTransactionSearch = e.target.value.trim();
        currentTransactionPage = 1;
        updateTransactionList();
    });
    
    document.getElementById('searchReferrals').addEventListener('input', (e) => {
        currentReferralSearch = e.target.value.trim();
        currentReferralPage = 1;
        updateReferralList();
    });
    
    // Export buttons
    document.getElementById('exportTransactions').addEventListener('click', exportTransactions);
    document.getElementById('exportReferrals').addEventListener('click', exportReferrals);
}

function toggleMenu() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('overlay').classList.toggle('open');
}

function switchTab(tab) {
    if (tab === 'transactions') {
        document.getElementById('transactionsTab').classList.add('tab-active');
        document.getElementById('referralsTab').classList.remove('tab-active');
        document.getElementById('transactionsContent').classList.add('active');
        document.getElementById('referralsContent').classList.remove('active');
    } else {
        document.getElementById('referralsTab').classList.add('tab-active');
        document.getElementById('transactionsTab').classList.remove('tab-active');
        document.getElementById('referralsContent').classList.add('active');
        document.getElementById('transactionsContent').classList.remove('active');
    }
}

function updateLanguage() {
    // Update all elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
            el.textContent = translations[currentLanguage][key];
        }
    });
    
    // Update placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
            el.setAttribute('placeholder', translations[currentLanguage][key]);
        }
    });
    
    // Update transaction list if it exists
    if (transactionHistory.length > 0) {
        updateTransactionList();
    }
    
    // Update referral list if it exists
    if (referralHistory.length > 0) {
        updateReferralList();
    }
}
function loadTransactionHistory() {
    // Show loading state
    document.getElementById('transactionsLoading').style.display = 'block';
    document.getElementById('transactionsList').style.display = 'none';
    document.getElementById('transactionsEmpty').style.display = 'none';

    // Get user ID from Telegram WebApp
    const userId = Telegram.WebApp.initDataUnsafe.user?.id;
    if (!userId) {
        console.error('User ID not available');
        document.getElementById('transactionsLoading').style.display = 'none';
        document.getElementById('transactionsEmpty').style.display = 'flex';
        return;
    }

    // Make API call to fetch transactions
    axios.get(`/api/transactions/${userId}`)
        .then(response => {
            
transactionHistory = response.data.map(item => {
    const isBuyOrder = item.hasOwnProperty('amountToBuy');
    const starRate = 0.009; // 1 star = 0.009 USDT
    
    return {
        id: item._id,
        type: isBuyOrder ? 'Stars Purchase' : 'Stars Sale',
        amount: isBuyOrder ? item.amountToBuy : item.amountToSell,
        usdtValue: (isBuyOrder ? item.amountToBuy : item.amountToSell) * starRate,
        status: mapOrderStatus(item.status),
        date: new Date(item.dateCreated),
        details: isBuyOrder 
            ? `Purchased ${item.amountToBuy} stars` 
            : `Sold ${item.amountToSell} stars for ${((item.amountToSell * starRate).toFixed(3))} USDT`
    };
});

// Update the transaction card display:
txnCard.innerHTML = `
    <div class="flex justify-between items-start mb-2">
        <div class="font-medium">${txn.type}</div>
        <div class="text-sm text-gray-500">${dateStr}</div>
    </div>
    <div class="flex justify-between items-center">
        <div>
            <div class="text-xs text-gray-500 mb-1">${txn.id}</div>
            <span class="status-badge ${statusClass}">${statusText}</span>
        </div>
        <div class="text-right">
            <div class="text-lg font-semibold">${txn.amount} ★</div>
            ${!txn.type.includes('Purchase') ? `<div class="text-sm text-gray-600">${txn.usdtValue.toFixed(3)} USDT</div>` : ''}
        </div>
    </div>
`;

// Helper function to map backend status to frontend status
function mapOrderStatus(backendStatus) {
    const statusMap = {
        'completed': 'completed',
        'pending': 'pending',
        'failed': 'declined',
        'cancelled': 'declined'
        // Add any other status mappings as needed
    };
    
    return statusMap[backendStatus] || 'pending';
}
    

function loadReferralHistory() {
    // Show loading state
    document.getElementById('referralsLoading').style.display = 'block';
    document.getElementById('referralsList').style.display = 'none';
    document.getElementById('referralsEmpty').style.display = 'none';

    // Get user ID from Telegram WebApp
    const userId = Telegram.WebApp.initDataUnsafe.user?.id;
    if (!userId) {
        console.error('User ID not available');
        document.getElementById('referralsLoading').style.display = 'none';
        document.getElementById('referralsEmpty').style.display = 'flex';
        return;
    }

    // Make API call to fetch referrals
    axios.get(`/api/referrals/${userId}`)
        .then(response => {
            // Transform the API response to match our expected format
            // Update the referral mapping:
referralHistory = response.data.map(ref => {
    const isReferrer = ref.referrerUserId === userId;
    
    return {
        id: ref._id,
        name: isReferrer ? 'Referred User' : 'Referrer',
        status: mapReferralStatus(ref.status),
        date: new Date(ref.dateReferred),
        amount: 0, // Default value since we're not showing rewards yet
        details: isReferrer ? 'You referred a user' : 'You were referred',
        isReferrer: isReferrer
    };
});

// Update the referral card display (remove amount display):
refCard.innerHTML = `
    <div class="flex justify-between items-start mb-2">
        <div class="font-medium">${ref.name}</div>
        <div class="text-sm text-gray-500">${dateStr}</div>
    </div>
    <div class="flex justify-between items-center">
        <div>
            <div class="text-xs text-gray-500 mb-1">${ref.id}</div>
            <span class="status-badge ${statusClass}">${statusText}</span>
        </div>
        <div class="text-sm text-gray-600">${ref.details}</div>
    </div>
`;


// Update the referral status mapping in your existing code
function mapReferralStatus(backendStatus) {
    const statusMap = {
        'completed': 'active',
        'pending': 'pending',
        'expired': 'declined'
        // Add any other status mappings as needed
    };
    
    return statusMap[backendStatus] || 'pending';
}
function updateTransactionList() {
    // Filter transactions based on current filter and search
    let filteredTransactions = transactionHistory.filter(txn => {
        // Apply status filter
        if (currentTransactionFilter !== 'all' && txn.status !== currentTransactionFilter) {
            return false;
        }
        
        // Apply search filter
        if (currentTransactionSearch) {
            const searchLower = currentTransactionSearch.toLowerCase();
            return (
                txn.id.toLowerCase().includes(searchLower) ||
                txn.type.toLowerCase().includes(searchLower) ||
                txn.amount.toString().includes(searchLower) ||
                txn.status.toLowerCase().includes(searchLower) ||
                txn.details.toLowerCase().includes(searchLower)
            );
        }
        
        return true;
    });
    
    // Calculate pagination
    const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
    const startIndex = (currentTransactionPage - 1) * itemsPerPage;
    const paginatedTransactions = filteredTransactions.slice(startIndex, startIndex + itemsPerPage);
    
    // Update counts
    updateTransactionCounts(filteredTransactions);
    
    // Hide loading state
    document.getElementById('transactionsLoading').style.display = 'none';
    
    // Check if we have transactions to show
    if (paginatedTransactions.length === 0) {
        document.getElementById('transactionsList').style.display = 'none';
        document.getElementById('transactionsEmpty').style.display = 'flex';
    } else {
        document.getElementById('transactionsList').style.display = 'block';
        document.getElementById('transactionsEmpty').style.display = 'none';
        
        // Render transactions
        const transactionsList = document.getElementById('transactionsList');
        transactionsList.innerHTML = '';
        
        paginatedTransactions.forEach(txn => {
            const txnCard = document.createElement('div');
            txnCard.className = 'transaction-card bg-white p-4';
            
            // Format date
            const dateStr = formatDate(txn.date);
            
            // Status badge class
            let statusClass = '';
            let statusText = '';
            switch(txn.status) {
                case 'completed':
                    statusClass = 'status-completed';
                    statusText = translations[currentLanguage].completed;
                    break;
                case 'pending':
                    statusClass = 'status-pending';
                    statusText = translations[currentLanguage].pending;
                    break;
                case 'declined':
                    statusClass = 'status-declined';
                    statusText = translations[currentLanguage].declined;
                    break;
            }
            
            txnCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-medium">${txn.type}</div>
                    <div class="text-sm text-gray-500">${dateStr}</div>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-xs text-gray-500 mb-1">${txn.id}</div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="text-lg font-semibold">${txn.amount} ★</div>
                </div>
            `;
            
            // Add click handler for details
            txnCard.addEventListener('click', () => showTransactionDetails(txn));
            
            transactionsList.appendChild(txnCard);
        });
    }
    
    // Update pagination controls
    updatePagination('transactionsPagination', currentTransactionPage, totalPages, (page) => {
        currentTransactionPage = page;
        updateTransactionList();
    });
}

function updateReferralList() {
    // Filter referrals based on current filter and search
    let filteredReferrals = referralHistory.filter(ref => {
        // Apply status filter
        if (currentReferralFilter !== 'all' && ref.status !== currentReferralFilter) {
            return false;
        }
        
        // Apply search filter
        if (currentReferralSearch) {
            const searchLower = currentReferralSearch.toLowerCase();
            return (
                ref.id.toLowerCase().includes(searchLower) ||
                ref.name.toLowerCase().includes(searchLower) ||
                ref.amount.toString().includes(searchLower) ||
                ref.status.toLowerCase().includes(searchLower) ||
                ref.details.toLowerCase().includes(searchLower)
            );
        }
        
        return true;
    });
    
    // Calculate pagination
    const totalPages = Math.ceil(filteredReferrals.length / itemsPerPage);
    const startIndex = (currentReferralPage - 1) * itemsPerPage;
    const paginatedReferrals = filteredReferrals.slice(startIndex, startIndex + itemsPerPage);
    
    // Hide loading state
    document.getElementById('referralsLoading').style.display = 'none';
    
    // Check if we have referrals to show
    if (paginatedReferrals.length === 0) {
        document.getElementById('referralsList').style.display = 'none';
        document.getElementById('referralsEmpty').style.display = 'flex';
    } else {
        document.getElementById('referralsList').style.display = 'block';
        document.getElementById('referralsEmpty').style.display = 'none';
        
        // Render referrals
        const referralsList = document.getElementById('referralsList');
        referralsList.innerHTML = '';
        
        paginatedReferrals.forEach(ref => {
            const refCard = document.createElement('div');
            refCard.className = 'transaction-card bg-white p-4';
            
            // Format date
            const dateStr = formatDate(ref.date);
            
            // Status badge class
            let statusClass = '';
            let statusText = '';
            switch(ref.status) {
                case 'active':
                    statusClass = 'status-completed';
                    statusText = translations[currentLanguage].active;
                    break;
                case 'pending':
                    statusClass = 'status-pending';
                    statusText = translations[currentLanguage].pending;
                    break;
            }
            
            refCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-medium">${ref.name}</div>
                    <div class="text-sm text-gray-500">${dateStr}</div>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-xs text-gray-500 mb-1">${ref.id}</div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="text-lg font-semibold">+${ref.amount} ★</div>
                </div>
            `;
            
            // Add click handler for details
            refCard.addEventListener('click', () => showReferralDetails(ref));
            
            referralsList.appendChild(refCard);
        });
    }
    
    // Update pagination controls
    updatePagination('referralsPagination', currentReferralPage, totalPages, (page) => {
        currentReferralPage = page;
        updateReferralList();
    });
}

function updateTransactionCounts(transactions) {
    const completedCount = transactions.filter(t => t.status === 'completed').length;
    const pendingCount = transactions.filter(t => t.status === 'pending').length;
    const declinedCount = transactions.filter(t => t.status === 'declined').length;
    
    document.getElementById('completedCount').textContent = completedCount;
    document.getElementById('pendingCount').textContent = pendingCount;
    document.getElementById('declinedCount').textContent = declinedCount;
}

function updateTransactionChart() {
    const ctx = document.getElementById('transactionChart').getContext('2d');
    
    // Group transactions by day for the last 7 days
    const now = new Date();
    const days = [];
    const data = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(now.getDate() - i);
        days.push(formatDate(date, true));
        
        const dayStart = new Date(date);
        dayStart.setHours(0, 0, 0, 0);
        const dayEnd = new Date(date);
        dayEnd.setHours(23, 59, 59, 999);
        
        const dayTransactions = transactionHistory.filter(txn => 
            txn.date >= dayStart && txn.date <= dayEnd && txn.status === 'completed'
        );
        
        const dayTotal = dayTransactions.reduce((sum, txn) => sum + txn.amount, 0);
        data.push(dayTotal);
    }
    
    // Destroy previous chart if it exists
    if (transactionChart) {
        transactionChart.destroy();
    }
    
    // Create new chart
    transactionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: days,
            datasets: [{
                label: translations[currentLanguage].total,
                data: data,
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderColor: 'rgba(79, 70, 229, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true,
                pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${translations[currentLanguage].total}: ${context.raw} ★`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + ' ★';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function updatePagination(elementId, currentPage, totalPages, callback) {
    const paginationContainer = document.getElementById(elementId);
    paginationContainer.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevButton = document.createElement('button');
    prevButton.className = 'pagination-btn border';
    prevButton.innerHTML = '&lt;';
    prevButton.disabled = currentPage === 1;
    prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
            callback(currentPage - 1);
        }
    });
    paginationContainer.appendChild(prevButton);
    
    // Page buttons
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    if (startPage > 1) {
        const firstButton = document.createElement('button');
        firstButton.className = 'pagination-btn border';
        firstButton.textContent = '1';
        firstButton.addEventListener('click', () => callback(1));
        paginationContainer.appendChild(firstButton);
        
        if (startPage > 2) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-2';
            ellipsis.textContent = '...';
            paginationContainer.appendChild(ellipsis);
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.className = `pagination-btn border ${i === currentPage ? 'active' : ''}`;
        pageButton.textContent = i;
        pageButton.addEventListener('click', () => callback(i));
        paginationContainer.appendChild(pageButton);
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-2';
            ellipsis.textContent = '...';
            paginationContainer.appendChild(ellipsis);
        }
        
        const lastButton = document.createElement('button');
        lastButton.className = 'pagination-btn border';
        lastButton.textContent = totalPages;
        lastButton.addEventListener('click', () => callback(totalPages));
        paginationContainer.appendChild(lastButton);
    }
    
    // Next button
    const nextButton = document.createElement('button');
    nextButton.className = 'pagination-btn border';
    nextButton.innerHTML = '&gt;';
    nextButton.disabled = currentPage === totalPages;
    nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
            callback(currentPage + 1);
        }
    });
    paginationContainer.appendChild(nextButton);
}

function formatDate(date, short = false) {
    const now = new Date();
    const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (short) {
        // For chart labels
        const options = { weekday: 'short' };
        return new Intl.DateTimeFormat(currentLanguage === 'ru' ? 'ru-RU' : 'en-US', options).format(date);
    }
    
    if (diffInDays === 0) {
        return translations[currentLanguage].today;
    } else if (diffInDays === 1) {
        return translations[currentLanguage].yesterday;
    } else if (diffInDays < 7) {
        return `${diffInDays} ${translations[currentLanguage].days_ago}`;
    } else {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Intl.DateTimeFormat(currentLanguage === 'ru' ? 'ru-RU' : 'en-US', options).format(date);
    }
}

function showTransactionDetails(transaction) {
    let statusClass = '';
    let statusText = '';
    switch(transaction.status) {
        case 'completed':
            statusClass = 'status-completed';
            statusText = translations[currentLanguage].completed;
            break;
        case 'pending':
            statusClass = 'status-pending';
            statusText = translations[currentLanguage].pending;
            break;
        case 'declined':
            statusClass = 'status-declined';
            statusText = translations[currentLanguage].declined;
            break;
    }
    
    Swal.fire({
        title: translations[currentLanguage].transaction_details,
        html: `
            <div class="text-left space-y-3">
                <div>
                    <span class="text-gray-500">${translations[currentLanguage].id}:</span>
                    <span class="ml-2 font-medium">${transaction.id}</span>
                </div>
                <div>
                    <span class="text-gray-500">${translations[currentLanguage].type}:</span>
                    <span class="ml-2 font-medium">${transaction.type}</span>
                </div>
                <div>
                    <span class="text-gray-500">${translations[currentLanguage].amount}:</span>
                    <span class="ml-2 font-medium">${transaction.amount} ★</span>
                </div>
                <div>
                    <span class="text-gray-500">${translations[currentLanguage].status}:</span>
                    <span class="ml-2 status-badge ${statusClass}">${statusText}</span>
                </div>
                <div>
                    <span class="text-gray-500">${translations[currentLanguage].date}:</span>
                    <span class="ml-2 font-medium">${formatDate(transaction.date)}</span>
                </div>
                <div class="pt-3 border-t">
                    <p class="text-gray-700">${transaction.details}</p>
                </div>
            </div>
        `,
        confirmButtonText: translations[currentLanguage].close,
        confirmButtonColor: '#4f46e5'
    });
}

function showReferralDetails(referral) {
    let statusClass = '';
    let statusText = '';
    switch(referral.status) {
        case 'active':
            statusClass = 'status-completed';
            statusText = translations[currentLanguage].active;
            break;
        case 'pending':
            statusClass = 'status-pending';
            statusText = translations[currentLanguage].pending;
            break;
    }
    
    Swal.fire({
        title: translations[currentLanguage].referral_details,
        html: `
            <div class="text-left space-y-3">
                <div>
                    <span class="text-gray-500">${translations[currentLanguage].id}:</span>
                    <span class="ml-2 font-medium">${referral.id}</span>
                </div>
                <div>
                    <span class="text-gray-500">${translations[currentLanguage].name}:</span>
                    <span class="ml-2 font-medium">${referral.name}</span>
                </div>
                <div>
                    <span class="text-gray-500">${translations[currentLanguage].amount}:</span>
                    <span class="ml-2 font-medium">${referral.amount} ★</span>
                </div>
                <div>
                    <span class="text-gray-500">${translations[currentLanguage].status}:</span>
                    <span class="ml-2 status-badge ${statusClass}">${statusText}</span>
                </div>
                <div>
                    <span class="text-gray-500">${translations[currentLanguage].date}:</span>
                    <span class="ml-2 font-medium">${formatDate(referral.date)}</span>
                </div>
                <div class="pt-3 border-t">
                    <p class="text-gray-700">${referral.details}</p>
                </div>
            </div>
        `,
        confirmButtonText: translations[currentLanguage].close,
        confirmButtonColor: '#4f46e5'
    });
}

function exportTransactions() {
    // Filter transactions based on current filter and search
    let filteredTransactions = transactionHistory.filter(txn => {
        // Apply status filter
        if (currentTransactionFilter !== 'all' && txn.status !== currentTransactionFilter) {
            return false;
        }
        
        // Apply search filter
        if (currentTransactionSearch) {
            const searchLower = currentTransactionSearch.toLowerCase();
            return (
                txn.id.toLowerCase().includes(searchLower) ||
                txn.type.toLowerCase().includes(searchLower) ||
                txn.amount.toString().includes(searchLower) ||
                txn.status.toLowerCase().includes(searchLower) ||
                txn.details.toLowerCase().includes(searchLower)
            );
        }
        
        return true;
    });
    
    // Convert to CSV
    let csv = 'ID,Type,Amount,Status,Date,Details\n';
    filteredTransactions.forEach(txn => {
        csv += `"${txn.id}","${txn.type}","${txn.amount}","${txn.status}","${formatDate(txn.date, true)}","${txn.details}"\n`;
    });
    
    // Create download link
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `transactions_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success message
    Swal.fire({
        title: 'Success',
        text: 'Transactions exported successfully',
        icon: 'success',
        confirmButtonText: translations[currentLanguage].close,
        confirmButtonColor: '#4f46e5'
    });
}

function exportReferrals() {
    // Filter referrals based on current filter and search
    let filteredReferrals = referralHistory.filter(ref => {
        // Apply status filter
        if (currentReferralFilter !== 'all' && ref.status !== currentReferralFilter) {
            return false;
        }
        
        // Apply search filter
        if (currentReferralSearch) {
            const searchLower = currentReferralSearch.toLowerCase();
            return (
                ref.id.toLowerCase().includes(searchLower) ||
                ref.name.toLowerCase().includes(searchLower) ||
                ref.amount.toString().includes(searchLower) ||
                ref.status.toLowerCase().includes(searchLower) ||
                ref.details.toLowerCase().includes(searchLower)
            );
        }
        
        return true;
    });
    
    // Convert to CSV
    let csv = 'ID,Name,Amount,Status,Date,Details\n';
    filteredReferrals.forEach(ref => {
        csv += `"${ref.id}","${ref.name}","${ref.amount}","${ref.status}","${formatDate(ref.date, true)}","${ref.details}"\n`;
    });
    
    // Create download link
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `referrals_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success message
    Swal.fire({
        title: 'Success',
        text: 'Referrals exported successfully',
        icon: 'success',
        confirmButtonText: translations[currentLanguage].close,
        confirmButtonColor: '#4f46e5'
    });
}
</script>
</body>
</html>
