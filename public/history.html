 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, shrink-to-fit=no, viewport-fit=cover">
    <title>StarStore - Transaction History</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="js/translations.js"></script>
    <script src="js/loading.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f3f4f6;
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
            position: relative;
            overflow: hidden;
            padding-bottom: 64px;
        }

        /* Simple Telegram Mini App styles */
        .telegram-fullscreen .app-container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            box-shadow: none;
            border-radius: 0;
        }
        .logo-header {
            font-size: 24px;
            font-weight: bold;
            color: #4f46e5;
            text-align: left;
            padding: 16px;
            background: linear-gradient(90deg, #4f46e5, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            width: fit-content;
        }
        
        .tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        

        .transaction-card {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            overflow: hidden;
        }
        .transaction-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }
        .status-badge {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 20px;
            font-weight: 500;
        }
        .status-completed {
            background: #ecfdf5;
            color: #059669;
        }
        .status-processing {
            background: #eff6ff;
            color: #2563eb;
        }
        .status-declined {
            background: #fef2f2;
            color: #dc2626;
        }
        .status-active {
            background: #ecfdf5;
            color: #059669;
        }
        .chart-container {
            position: relative;
            height: 220px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #6b7280;
        }
        .empty-state svg {
            width: 80px;
            height: 80px;
            color: #d1d5db;
            margin-bottom: 16px;
        }
        .pagination-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .pagination-btn.active {
            background: #4f46e5;
            color: white;
        }
        .filter-active {
            background: #eef2ff;
            color: #4f46e5;
            border-color: #4f46e5;
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .shimmer {
            position: relative;
            overflow: hidden;
        }
        .shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.2) 20%, 
                rgba(255,255,255,0.5) 60%, 
                rgba(255,255,255,0) 100%);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="bottomnav-container"></div>

        <div class="p-3 md:p-4 flex justify-between items-center bg-white shadow-sm">
            <div class="p-2"></div>
            <div class="logo-header">StarStore</div>
            <div></div>
        </div>
        
        <div class="px-4">
            <div class="flex border-b mb-6">
                <button id="transactionsTab" class="flex-1 py-3 text-center tab-active" data-translate="transactions">
                    Transactions
                </button>
                <button id="referralsTab" class="flex-1 py-3 text-center" data-translate="referrals">
                    Referrals
                </button>
            </div>
            
            <div id="transactionsContent" class="tab-content active">
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-4" data-translate="overview">Overview</h3>
                    <div class="chart-container">
                        <canvas id="transactionChart"></canvas>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mt-4">
                        <div class="text-center p-2 rounded-lg bg-green-50">
                            <div class="text-green-600 text-xl font-semibold" id="completedCount">0</div>
                            <div class="text-xs text-green-800" data-translate="completed">Completed</div>
                        </div>
                        <div class="text-center p-2 rounded-lg bg-blue-50">
                            <div class="text-blue-600 text-xl font-semibold" id="processingCount">0</div>
                            <div class="text-xs text-blue-800" data-translate="processing">Processing</div>
                        </div>
                        <div class="text-center p-2 rounded-lg bg-red-50">
                            <div class="text-red-600 text-xl font-semibold" id="declinedCount">0</div>
                            <div class="text-xs text-red-800" data-translate="declined">Declined</div>
                        </div>
                    </div>
                </div>
                
                <div class="flex mb-4 space-x-2 overflow-x-auto pb-2 scrollbar-hide">
                    <button class="filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap filter-active" data-filter="all" data-translate="all">All</button>
                    <button class="filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap" data-filter="completed" data-translate="completed">Completed</button>
                    <button class="filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap" data-filter="processing" data-translate="processing">Processing</button>
                    <button class="filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap" data-filter="declined" data-translate="declined">Declined</button>
                </div>
                
                <div class="relative mb-6">
                    <input type="text" id="searchTransactions" class="w-full p-3 pl-10 pr-4 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Search transactions...">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                </div>
                
                <div id="transactionsLoading" class="space-y-4 mb-6"></div>
                
                <div id="transactionsList" class="space-y-4 mb-6" style="display:none"></div>
                
                <div id="transactionsEmpty" class="empty-state" style="display:none">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <p class="text-center" data-translate="noTransactions">No transactions found</p>
                </div>
                
                <div id="transactionsPagination" class="flex justify-center items-center gap-2 mb-6"></div>
                
                <button id="exportTransactions" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors mb-8 flex justify-center items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <span data-translate="exportTransactions">Export Transactions</span>
                </button>
            </div>
            
            <div id="referralsContent" class="tab-content">
                <div class="flex mb-4 space-x-2 overflow-x-auto pb-2 scrollbar-hide">
                    <button class="ref-filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap filter-active" data-filter="all" data-translate="all">All</button>
                    <button class="ref-filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap" data-filter="active" data-translate="active">Active</button>
                    <button class="ref-filter-btn px-4 py-2 rounded-full border text-sm whitespace-nowrap" data-filter="processing" data-translate="processing">Processing</button>
                </div>
                
                <div class="relative mb-6">
                    <input type="text" id="searchReferrals" class="w-full p-3 pl-10 pr-4 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Search referrals...">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                </div>
                
                <div id="referralsLoading" class="space-y-4 mb-6"></div>
                
                <div id="referralsList" class="space-y-4 mb-6" style="display:none"></div>
                
                <div id="referralsEmpty" class="empty-state" style="display:none">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <p class="text-center" data-translate="noReferrals">No referrals found</p>
                </div>
                
                <div id="referralsPagination" class="flex justify-center items-center gap-2 mb-6"></div>
                
                <button id="exportReferrals" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors mb-8 flex justify-center items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <span data-translate="exportReferrals">Export Referrals</span>
                </button>
            </div>
        </div>
    </div>
<script>
// Initialize Telegram WebApp
if (window.Telegram?.WebApp) {
    const webApp = window.Telegram.WebApp;
    webApp.ready();
    webApp.expand();
    
    // Add fullscreen class to body
    document.body.classList.add('telegram-fullscreen');
    
    console.log('Telegram Mini App mode enabled');
}

const user = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) ? window.Telegram.WebApp.initDataUnsafe.user : null;
const BASE_API_URL = window.location.origin + '/api';

let transactionHistory = [];
let referralHistory = [];
let currentTransactionPage = 1;
let currentReferralPage = 1;
let currentTransactionFilter = 'all';
let currentReferralFilter = 'all';
let currentTransactionSearch = '';
let currentReferralSearch = '';
const itemsPerPage = 5;
let currentLanguage = TranslationUtils.getCurrentLanguage();
let transactionChart = null;

// Initialize translations
if (typeof TranslationUtils !== 'undefined') {
    TranslationUtils.init();
}

document.addEventListener('DOMContentLoaded', () => {
    initApp();
});



function initApp() {
    updateLanguage();
    setupEventListeners();
    loadTransactionHistory();
    loadReferralHistory();
    window.addEventListener('storage', (event) => {
        if (event.key === 'appLanguage') {
            currentLanguage = event.newValue || 'en';
            updateLanguage();
        }
    });
    // load shared bottom nav
    fetch('bottomnav.html').then(r => r.ok ? r.text() : '').then(html => { 
        document.getElementById('bottomnav-container').innerHTML = html; 
        // Apply translations to bottom nav after loading
        if (typeof TranslationUtils !== 'undefined') {
            TranslationUtils.applyTranslations();
        }
    });
}

function setupEventListeners() {
    document.getElementById('transactionsTab').addEventListener('click', () => switchTab('transactions'));
    document.getElementById('referralsTab').addEventListener('click', () => switchTab('referrals'));
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const filter = btn.getAttribute('data-filter');
            currentTransactionFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('filter-active'));
            btn.classList.add('filter-active');
            currentTransactionPage = 1;
            updateTransactionList();
        });
    });
    document.querySelectorAll('.ref-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const filter = btn.getAttribute('data-filter');
            currentReferralFilter = filter;
            document.querySelectorAll('.ref-filter-btn').forEach(b => b.classList.remove('filter-active'));
            btn.classList.add('filter-active');
            currentReferralPage = 1;
            updateReferralList();
        });
    });
    document.getElementById('searchTransactions').addEventListener('input', (e) => {
        currentTransactionSearch = e.target.value.trim();
        currentTransactionPage = 1;
        updateTransactionList();
    });
    document.getElementById('searchReferrals').addEventListener('input', (e) => {
        currentReferralSearch = e.target.value.trim();
        currentReferralPage = 1;
        updateReferralList();
    });
    document.getElementById('exportTransactions').addEventListener('click', exportTransactions);
    document.getElementById('exportReferrals').addEventListener('click', exportReferrals);
}

function switchTab(tab) {
    if (tab === 'transactions') {
        document.getElementById('transactionsTab').classList.add('tab-active');
        document.getElementById('referralsTab').classList.remove('tab-active');
        document.getElementById('transactionsContent').classList.add('active');
        document.getElementById('referralsContent').classList.remove('active');
    } else {
        document.getElementById('referralsTab').classList.add('tab-active');
        document.getElementById('transactionsTab').classList.remove('tab-active');
        document.getElementById('referralsContent').classList.add('active');
        document.getElementById('transactionsContent').classList.remove('active');
    }
}

function updateLanguage() {
    // Use TranslationUtils for better translation management
    if (typeof TranslationUtils !== 'undefined') {
        TranslationUtils.applyTranslations();
    }
    if (transactionHistory.length > 0) updateTransactionList();
    if (referralHistory.length > 0) updateReferralList();
}

function loadTransactionHistory() {
            LoadingComponent.show('transactionsLoading', 'cards', { count: 3 });
    document.getElementById('transactionsList').style.display = 'none';
    document.getElementById('transactionsEmpty').style.display = 'none';

    if (!user || !user.id) {
        LoadingComponent.hide('transactionsLoading');
        document.getElementById('transactionsEmpty').style.display = 'flex';
        // Render an empty chart so the UI doesn't look broken
        transactionHistory = [];
        updateTransactionChart();
        return;
    }

    fetch(`${BASE_API_URL}/transactions/${user.id}`, {
        headers: {
            'x-telegram-init-data': Telegram.WebApp.initData,
            'x-telegram-id': user.id,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        console.log('📊 Received transaction data:', data);
        console.log('📊 Data length:', data.length);
        
        // Add visual debug indicator
        const debugDiv = document.createElement('div');
        debugDiv.style.cssText = 'position:fixed;top:10px;right:10px;background:red;color:white;padding:10px;z-index:9999;font-size:12px;';
        debugDiv.innerHTML = `Data: ${data.length} items`;
        document.body.appendChild(debugDiv);
        
        transactionHistory = data.map(item => {
            return {
                ...item,
                status: mapOrderStatus(item.status),
                date: new Date(item.date)
            };
        });
        
        console.log('📊 Processed transactionHistory:', transactionHistory);
        console.log('📊 TransactionHistory length:', transactionHistory.length);
        
        updateTransactionList();
        updateTransactionChart();
    })
    .catch(error => {
        LoadingComponent.hide('transactionsLoading');
        document.getElementById('transactionsEmpty').style.display = 'flex';
        // Still show an empty chart on errors
        transactionHistory = [];
        updateTransactionChart();
    });
}

function loadReferralHistory() {
    LoadingComponent.show('referralsLoading', 'cards', { count: 3 });
    document.getElementById('referralsList').style.display = 'none';
    document.getElementById('referralsEmpty').style.display = 'none';

    if (!user || !user.id) {
        LoadingComponent.hide('referralsLoading');
        document.getElementById('referralsEmpty').style.display = 'flex';
        return;
    }

    fetch(`${BASE_API_URL}/referrals/${user.id}`, {
        headers: {
            'x-telegram-init-data': Telegram.WebApp.initData,
            'x-telegram-id': user.id,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        console.log('👥 Received referral data:', data);
        console.log('👥 Referral data length:', data.length);
        
        referralHistory = data.map(ref => {
            return {
                ...ref,
                status: mapReferralStatus(ref.status),
                date: new Date(ref.date)
            };
        });
        
        console.log('👥 Processed referralHistory:', referralHistory);
        console.log('👥 ReferralHistory length:', referralHistory.length);
        
        updateReferralList();
    })
    .catch(error => {
        LoadingComponent.hide('referralsLoading');
        document.getElementById('referralsEmpty').style.display = 'flex';
    });
}

function mapOrderStatus(status) {
    const statusMap = {
        'completed': 'completed',
        'processing': 'processing',
        'pending': 'pending',
        'failed': 'declined',
        'declined': 'declined',
        'refunded': 'declined'
    };
    if (!status || typeof status !== 'string') return 'processing';
    return statusMap[status.toLowerCase()] || 'processing';
}

function mapReferralStatus(status) {
    const statusMap = {
        'completed': 'active',
        'active': 'active',
        'pending': 'processing',
        'processing': 'processing'
    };
    if (!status || typeof status !== 'string') return 'processing';
    return statusMap[status.toLowerCase()] || 'processing';
}

function updateTransactionList() {
    console.log('🔄 updateTransactionList called');
    console.log('🔄 transactionHistory length:', transactionHistory.length);
    console.log('🔄 currentTransactionFilter:', currentTransactionFilter);
    console.log('🔄 currentTransactionSearch:', currentTransactionSearch);
    
    let filteredTransactions = transactionHistory.filter(txn => {
        if (currentTransactionFilter !== 'all' && txn.status !== currentTransactionFilter) return false;
        if (currentTransactionSearch) {
            const searchLower = currentTransactionSearch.toLowerCase();
            return (
                (txn.id || '').toString().toLowerCase().includes(searchLower) ||
                (txn.type || '').toString().toLowerCase().includes(searchLower) ||
                (txn.amount ?? '').toString().toLowerCase().includes(searchLower) ||
                (txn.status || '').toString().toLowerCase().includes(searchLower) ||
                (txn.details || '').toString().toLowerCase().includes(searchLower)
            );
        }
        return true;
    });
    
    const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
    const startIndex = (currentTransactionPage - 1) * itemsPerPage;
    const paginatedTransactions = filteredTransactions.slice(startIndex, startIndex + itemsPerPage);
    
    console.log('🔄 filteredTransactions length:', filteredTransactions.length);
    console.log('🔄 paginatedTransactions length:', paginatedTransactions.length);
    
    updateTransactionCounts(filteredTransactions);
    LoadingComponent.hide('transactionsLoading');
    
    if (paginatedTransactions.length === 0) {
        document.getElementById('transactionsList').style.display = 'none';
        document.getElementById('transactionsEmpty').style.display = 'flex';
    } else {
        document.getElementById('transactionsList').style.display = 'block';
        document.getElementById('transactionsEmpty').style.display = 'none';
        
        const transactionsList = document.getElementById('transactionsList');
        transactionsList.innerHTML = '';
        
        paginatedTransactions.forEach(txn => {
            const txnCard = document.createElement('div');
            txnCard.className = 'transaction-card bg-white p-4';
            const dateStr = formatDate(txn.date);
            let statusClass = '';
            let statusText = '';
            
            switch(txn.status) {
                case 'completed':
                    statusClass = 'status-completed';
                    statusText = TranslationUtils.get('completed');
                    break;
                case 'processing':
                    statusClass = 'status-processing';
                    statusText = TranslationUtils.get('processing');
                    break;
                case 'declined':
                    statusClass = 'status-declined';
                    statusText = TranslationUtils.get('declined');
                    break;
            }
            
            txnCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-medium">${txn.type}</div>
                    <div class="text-sm text-gray-500">${dateStr}</div>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-xs text-gray-500 mb-1">${txn.id}</div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-semibold">${txn.amount} ★</div>
                        ${txn.usdtValue ? `<div class="text-sm text-gray-600">${txn.usdtValue.toFixed(3)} USDT</div>` : ''}
                    </div>
                </div>
            `;
            txnCard.addEventListener('click', () => showTransactionDetails(txn));
            transactionsList.appendChild(txnCard);
        });
    }
    
    updatePagination('transactionsPagination', currentTransactionPage, totalPages, (page) => {
        currentTransactionPage = page;
        updateTransactionList();
    });
}

function updateReferralList() {
    let filteredReferrals = referralHistory.filter(ref => {
        if (currentReferralFilter !== 'all' && ref.status !== currentReferralFilter) return false;
        if (currentReferralSearch) {
            const searchLower = currentReferralSearch.toLowerCase();
            return (
                (ref.id || '').toString().toLowerCase().includes(searchLower) ||
                (ref.name || '').toString().toLowerCase().includes(searchLower) ||
                (ref.amount ?? '').toString().toLowerCase().includes(searchLower) ||
                (ref.status || '').toString().toLowerCase().includes(searchLower) ||
                (ref.details || '').toString().toLowerCase().includes(searchLower)
            );
        }
        return true;
    });
    
    const totalPages = Math.ceil(filteredReferrals.length / itemsPerPage);
    const startIndex = (currentReferralPage - 1) * itemsPerPage;
    const paginatedReferrals = filteredReferrals.slice(startIndex, startIndex + itemsPerPage);
    
    LoadingComponent.hide('referralsLoading');
    
    if (paginatedReferrals.length === 0) {
        document.getElementById('referralsList').style.display = 'none';
        document.getElementById('referralsEmpty').style.display = 'flex';
    } else {
        document.getElementById('referralsList').style.display = 'block';
        document.getElementById('referralsEmpty').style.display = 'none';
        
        const referralsList = document.getElementById('referralsList');
        referralsList.innerHTML = '';
        
        paginatedReferrals.forEach(ref => {
            const refCard = document.createElement('div');
            refCard.className = 'transaction-card bg-white p-4';
            const dateStr = formatDate(ref.date);
            let statusClass = '';
            let statusText = '';
            
            switch(ref.status) {
                case 'active':
                    statusClass = 'status-active';
                    statusText = TranslationUtils.get('active');
                    break;
                case 'processing':
                    statusClass = 'status-processing';
                    statusText = TranslationUtils.get('processing');
                    break;
            }
            
            refCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-medium">${ref.name}</div>
                    <div class="text-sm text-gray-500">${dateStr}</div>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-xs text-gray-500 mb-1">${ref.id}</div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="text-sm text-gray-600">${ref.details}</div>
                </div>
            `;
            refCard.addEventListener('click', () => showReferralDetails(ref));
            referralsList.appendChild(refCard);
        });
    }
    
    updatePagination('referralsPagination', currentReferralPage, totalPages, (page) => {
        currentReferralPage = page;
        updateReferralList();
    });
}

function updateTransactionCounts(transactions) {
    document.getElementById('completedCount').textContent = transactions.filter(t => t.status === 'completed').length;
    document.getElementById('processingCount').textContent = transactions.filter(t => t.status === 'processing').length;
    document.getElementById('declinedCount').textContent = transactions.filter(t => t.status === 'declined').length;
}

function updateTransactionChart() {
    const ctx = document.getElementById('transactionChart').getContext('2d');
    const now = new Date();
    const days = [];
    const data = [];
    
    const filteredTransactions = transactionHistory.filter(t => t.status === 'completed');
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(now.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        days.push(formatDate(date, true));
        
        const dailyTotal = filteredTransactions
            .filter(t => t.date.toISOString().split('T')[0] === dateStr)
            .reduce((sum, t) => sum + t.amount, 0);
            
        data.push(dailyTotal);
    }
    
    if (transactionChart) transactionChart.destroy();
    transactionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: days,
            datasets: [{
                label: TranslationUtils.get('total'),
                data: data,
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderColor: 'rgba(79, 70, 229, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true,
                pointBackgroundColor: 'rgba(79, 70, 229, 1)',
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${TranslationUtils.get('total')}: ${context.raw} ★`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + ' ★';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function updatePagination(elementId, currentPage, totalPages, callback) {
    const paginationContainer = document.getElementById(elementId);
    paginationContainer.innerHTML = '';
    if (totalPages <= 1) return;
    
    const prevButton = document.createElement('button');
    prevButton.className = 'pagination-btn border';
    prevButton.innerHTML = '&lt;';
    prevButton.disabled = currentPage === 1;
    prevButton.addEventListener('click', () => {
        if (currentPage > 1) callback(currentPage - 1);
    });
    paginationContainer.appendChild(prevButton);
    
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    if (startPage > 1) {
        const firstButton = document.createElement('button');
        firstButton.className = 'pagination-btn border';
        firstButton.textContent = '1';
        firstButton.addEventListener('click', () => callback(1));
        paginationContainer.appendChild(firstButton);
        
        if (startPage > 2) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-2';
            ellipsis.textContent = '...';
            paginationContainer.appendChild(ellipsis);
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.className = `pagination-btn border ${i === currentPage ? 'active' : ''}`;
        pageButton.textContent = i;
        pageButton.addEventListener('click', () => callback(i));
        paginationContainer.appendChild(pageButton);
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-2';
            ellipsis.textContent = '...';
            paginationContainer.appendChild(ellipsis);
        }
        
        const lastButton = document.createElement('button');
        lastButton.className = 'pagination-btn border';
        lastButton.textContent = totalPages;
        lastButton.addEventListener('click', () => callback(totalPages));
        paginationContainer.appendChild(lastButton);
    }
    
    const nextButton = document.createElement('button');
    nextButton.className = 'pagination-btn border';
    nextButton.innerHTML = '&gt;';
    nextButton.disabled = currentPage === totalPages;
    nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) callback(currentPage + 1);
    });
    paginationContainer.appendChild(nextButton);
}

function formatDate(date, short = false) {
    const now = new Date();
    const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (short) {
        const options = { weekday: 'short' };
        return new Intl.DateTimeFormat(currentLanguage === 'ru' ? 'ru-RU' : 'en-US', options).format(date);
    }
    
            if (diffInDays === 0) return TranslationUtils.get('today');
        else if (diffInDays === 1) return TranslationUtils.get('yesterday');
        else if (diffInDays < 7) return `${diffInDays} ${TranslationUtils.get('days_ago')}`;
    else {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Intl.DateTimeFormat(currentLanguage === 'ru' ? 'ru-RU' : 'en-US', options).format(date);
    }
}

function showTransactionDetails(transaction) {
    let statusClass = '';
    let statusText = '';
    
    switch(transaction.status) {
        case 'completed':
            statusClass = 'status-completed';
            statusText = TranslationUtils.get('completed');
            break;
        case 'processing':
            statusClass = 'status-processing';
            statusText = TranslationUtils.get('processing');
            break;
        case 'declined':
            statusClass = 'status-declined';
            statusText = TranslationUtils.get('declined');
            break;
    }
    
    Swal.fire({
        title: TranslationUtils.get('transaction_details'),
        html: `
            <div class="text-left space-y-3">
                <div>
                    <span class="text-gray-500">${TranslationUtils.get('id')}:</span>
                    <span class="ml-2 font-medium">${transaction.id}</span>
                </div>
                <div>
                    <span class="text-gray-500">${TranslationUtils.get('type')}:</span>
                    <span class="ml-2 font-medium">${transaction.type}</span>
                </div>
                <div>
                    <span class="text-gray-500">${TranslationUtils.get('amount')}:</span>
                    <span class="ml-2 font-medium">${transaction.amount} ★</span>
                </div>
                <div>
                    <span class="text-gray-500">${TranslationUtils.get('status')}:</span>
                    <span class="ml-2 status-badge ${statusClass}">${statusText}</span>
                </div>
                <div>
                    <span class="text-gray-500">${TranslationUtils.get('date')}:</span>
                    <span class="ml-2 font-medium">${formatDate(transaction.date)}</span>
                </div>
                <div class="pt-3 border-t">
                    <p class="text-gray-700">${transaction.details}</p>
                </div>
            </div>
        `,
        confirmButtonText: TranslationUtils.get('close'),
        confirmButtonColor: '#4f46e5'
    });
}

function showReferralDetails(referral) {
    let statusClass = '';
    let statusText = '';
    
    switch(referral.status) {
        case 'active':
            statusClass = 'status-active';
            statusText = TranslationUtils.get('active');
            break;
        case 'processing':
            statusClass = 'status-processing';
            statusText = TranslationUtils.get('processing');
            break;
    }
    
    Swal.fire({
        title: TranslationUtils.get('referral_details'),
        html: `
            <div class="text-left space-y-3">
                <div>
                    <span class="text-gray-500">${TranslationUtils.get('id')}:</span>
                    <span class="ml-2 font-medium">${referral.id}</span>
                </div>
                <div>
                    <span class="text-gray-500">${TranslationUtils.get('name')}:</span>
                    <span class="ml-2 font-medium">${referral.name}</span>
                </div>
                <div>
                    <span class="text-gray-500">${TranslationUtils.get('status')}:</span>
                    <span class="ml-2 status-badge ${statusClass}">${statusText}</span>
                </div>
                <div>
                    <span class="text-gray-500">${TranslationUtils.get('date')}:</span>
                    <span class="ml-2 font-medium">${formatDate(referral.date)}</span>
                </div>
                <div class="pt-3 border-t">
                    <p class="text-gray-700">${referral.details}</p>
                </div>
            </div>
        `,
        confirmButtonText: translations[currentLanguage].close,
        confirmButtonColor: '#4f46e5'
    });
}

function exportTransactions() {
    let filteredTransactions = transactionHistory.filter(txn => {
        if (currentTransactionFilter !== 'all' && txn.status !== currentTransactionFilter) return false;
        if (currentTransactionSearch) {
            const searchLower = currentTransactionSearch.toLowerCase();
            return (
                txn.id.toLowerCase().includes(searchLower) ||
                txn.type.toLowerCase().includes(searchLower) ||
                txn.amount.toString().includes(searchLower) ||
                txn.status.toLowerCase().includes(searchLower) ||
                txn.details.toLowerCase().includes(searchLower)
            );
        }
        return true;
    });
    
    let csv = 'ID,Type,Amount,Status,Date,Details\n';
    filteredTransactions.forEach(txn => {
        csv += `"${txn.id}","${txn.type}","${txn.amount}","${txn.status}","${formatDate(txn.date, true)}","${txn.details}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `transactions_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    Swal.fire({
        title: TranslationUtils.get('success'),
        text: TranslationUtils.get('exportTransactions'),
        icon: 'success',
        confirmButtonText: TranslationUtils.get('close'),
        confirmButtonColor: '#4f46e5'
    });
}

function exportReferrals() {
    let filteredReferrals = referralHistory.filter(ref => {
        if (currentReferralFilter !== 'all' && ref.status !== currentReferralFilter) return false;
        if (currentReferralSearch) {
            const searchLower = currentReferralSearch.toLowerCase();
            return (
                ref.id.toLowerCase().includes(searchLower) ||
                ref.name.toLowerCase().includes(searchLower) ||
                ref.amount.toString().includes(searchLower) ||
                ref.status.toLowerCase().includes(searchLower) ||
                ref.details.toLowerCase().includes(searchLower)
            );
        }
        return true;
    });
    
    let csv = 'ID,Name,Amount,Status,Date,Details\n';
    filteredReferrals.forEach(ref => {
        csv += `"${ref.id}","${ref.name}","${ref.amount}","${ref.status}","${formatDate(ref.date, true)}","${ref.details}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `referrals_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    Swal.fire({
        title: TranslationUtils.get('success'),
        text: TranslationUtils.get('exportReferrals'),
        icon: 'success',
        confirmButtonText: TranslationUtils.get('close'),
        confirmButtonColor: '#4f46e5'
    });
}


</script>
    
</body>
</html>
