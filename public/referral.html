<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, shrink-to-fit=no, viewport-fit=cover">
    <title>Referral - StarStore</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="js/translations.js?v=2"></script>
    <link rel="icon" href="/favicon.png" type="image/png">
    <script src="js/loading.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f3f4f6;
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            min-height: 100vh;
            position: relative;
            overflow: hidden;
            padding-bottom: 64px;
        }

        /* Simple Telegram Mini App styles */
        .telegram-fullscreen .app-container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            box-shadow: none;
            border-radius: 0;
        }
        .logo-header {
            font-size: 24px;
            font-weight: bold;
            color: #4f46e5;
            text-align: left;
            padding: 16px;
            background: linear-gradient(90deg, #4f46e5, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            width: fit-content;
        }
        

        .copy-button {
            transition: all 0.2s ease;
        }
        .copy-button:active {
            transform: scale(0.95);
        }
        .referral-stats {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            border-radius: 12px;
            color: white;
            min-height: 120px;
            display: block !important;
            visibility: visible !important;
        }
        .tab-button {
            transition: all 0.2s ease;
            position: relative;
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #4f46e5;
        }
        .referral-code {
            background: #f9fafb;
            border: 1px dashed #d1d5db;
            border-radius: 6px;
            font-family: monospace;
            font-size: 18px;
            letter-spacing: 1px;
        }
        .withdraw-form input {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 14px;
            width: 100%;
            transition: all 0.2s ease;
        }
        .withdraw-form input:focus {
            border-color: #4f46e5;
            outline: none;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        .withdraw-form button {
            background: #4f46e5;
            color: white;
            border-radius: 6px;
            padding: 10px 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .withdraw-form button:hover {
            background: #4338ca;
        }
        .withdraw-form button:active {
            transform: scale(0.98);
        }
        .hide {
            display: none;
        }
        .show {
            display: block;
        }
        
        /* Debug styles to ensure balance elements are visible */
        #availableBalance, #totalEarned, #referralsCount, #pendingAmount {
            display: block !important;
            visibility: visible !important;
            color: white !important;
        }
        .dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .dot-success {
            background-color: #10b981;
        }
        .dot-pending {
            background-color: #f59e0b;
        }
        .dot-failed {
            background-color: #ef4444;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 100;
            max-width: 90%;
            width: 320px;
            display: none;
        }
     
.share-button {
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.share-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.share-button:active {
    transform: translateY(0);
    box-shadow: none;
}
     
.withdrawal-item {
    transition: all 0.2s ease;
}

.withdrawal-item:hover {
    background-color: #f9fafb;
}

.status-pending {
    color: #f59e0b;
}

.status-completed {
    color: #10b981;
}

.status-declined {
    color: #ef4444;
}

.wallet-address {
    font-family: monospace;
    letter-spacing: 0.5px;
}
    </style>
</head>
<body>
    <div class="app-container">
        <div id="bottomnav-container"></div>
 
        <!-- Page Header -->
        <header class="px-4 py-3 bg-white border-b border-gray-200">
            <div class="flex items-center">
                <h1 class="text-lg font-semibold text-gray-900" data-translate="referral">Referral</h1>
            </div>
        </header>

        <div class="px-4 py-4">
            <div class="text-center mb-6">
                                    <h1 class="text-2xl font-bold text-gray-800 mb-2" data-translate="referralTitle">Referral Program</h1>
                    <p class="text-gray-600" data-translate="referralSubtitle">Invite friends and earn rewards</p>
            </div>

            <div class="referral-stats p-5 mb-6 text-white">
                <div class="flex justify-between mb-4">
                    <div>
                        <div class="text-sm opacity-80 mb-1" data-translate="availableBalance">Available Balance</div>
                        <div class="text-2xl font-bold" id="availableBalance">0.00 USDT</div>
                    </div>
                                          <button id="withdrawButton" class="bg-white text-indigo-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-50 transition-colors" data-translate="withdraw">Withdraw</button>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center pt-2">
                    <div>
                        <div class="text-sm opacity-80 mb-1" data-translate="totalEarned">Total Earned</div>
                        <div class="font-semibold" id="totalEarned">0.00 USDT</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-80 mb-1" data-translate="referrals">Referrals</div>
                        <div class="font-semibold" id="referralsCount">0</div>
                    </div>
                    <div>
                        <div class="text-sm opacity-80 mb-1" data-translate="pending">Pending</div>
                        <div class="font-semibold" id="pendingAmount">0.00 USDT</div>
                    </div>
                </div>
                

            </div>

            <div class="bg-white rounded-xl p-5 mb-6 border border-gray-100 shadow-sm">
                <h2 class="text-lg font-bold text-gray-800 mb-3" data-translate="yourLink">Your Referral Link</h2>
                <p class="text-gray-600 text-sm mb-4" data-translate="shareText">Share this link with friends and earn 0.5 USDT for every successful referral</p>
                
                <div class="flex items-center mb-4">
                    <div class="referral-code flex-1 py-3 px-4 mr-2 overflow-hidden overflow-ellipsis" id="referralLinkDisplay">
                        <span data-translate="loading">Loading...</span>
                    </div>
                    <button id="copyButton" class="copy-button bg-indigo-100 text-indigo-600 p-3 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </button>
                </div>
             
             <div class="grid grid-cols-4 gap-2 mb-4">
    <button class="share-button bg-indigo-500 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-indigo-600 transition-colors flex items-center justify-center min-w-0" id="shareTg" aria-label="Share on Telegram" aria-labelledby="shareTgLabel">
        <svg class="w-3 h-3 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.225l-2.237 10.54c-.168.746-.765.926-1.55.576l-4.275-3.15-2.064 1.984c-.23.23-.42.42-.85.42l.305-4.305 7.83-7.07c.34-.305-.074-.473-.523-.168l-9.67 6.08-4.16-1.298c-.9-.277-.915-.9.187-1.33l16.262-6.262c.746-.275 1.394.182 1.146 1.355z"/>
        </svg>
                                <span id="shareTgLabel" data-translate="shareTg" class="truncate">Share</span>
    </button>
    <button class="share-button bg-blue-500 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-blue-600 transition-colors flex items-center justify-center min-w-0" id="shareFb" aria-label="Share on Facebook" aria-labelledby="shareFbLabel">
        <svg class="w-3 h-3 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.351c0 .731.593 1.324 1.325 1.324h11.495v-9.294h-3.128v-3.622h3.128v-2.671c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12v9.293h6.116c.73 0 1.323-.593 1.323-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z"/>
        </svg>
                                <span id="shareFbLabel" data-translate="shareFb" class="truncate">Share</span>
    </button>
    <button class="share-button bg-blue-400 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-blue-500 transition-colors flex items-center justify-center min-w-0" id="shareTw" aria-label="Share on Twitter" aria-labelledby="shareTwLabel">
        <svg class="w-3 h-3 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
        </svg>
                                <span id="shareTwLabel" data-translate="shareTw" class="truncate">Share</span>
    </button>
    <button class="share-button bg-green-500 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-green-600 transition-colors flex items-center justify-center min-w-0" id="shareWa" aria-label="Share on WhatsApp" aria-labelledby="shareWaLabel">
        <svg class="w-3 h-3 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/>
        </svg>
                                <span id="shareWaLabel" data-translate="shareWa" class="truncate">Share</span>
    </button>
</div>

                
                <div class="bg-indigo-50 rounded-lg p-4 text-indigo-800 text-sm flex items-start">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span data-translate="referralInfo">
                        You will earn 0.5 USDT for each successful referral. 
                        Earnings can be withdrawn to your TON wallet.
                    </span>
                </div>
            </div>

            <div class="bg-white rounded-xl p-5 mb-6 border border-gray-100 shadow-sm">
                <div class="flex border-b border-gray-200 mb-4">
                    <button class="tab-button active py-2 px-4 text-sm font-medium text-gray-800" data-tab="referrals" data-translate="myReferrals">My Referrals</button>
                    <button class="tab-button py-2 px-4 text-sm font-medium text-gray-500" data-tab="withdrawals" data-translate="withdrawals">Withdrawals</button>
                </div>
                
                <div id="referrals-tab" class="tab-content">
                    <div class="text-center py-8 text-gray-500" id="noReferrals">
                        <div class="inline-block p-3 bg-gray-100 rounded-full mb-3">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                        </div>
                        <p class="text-sm mb-2" data-translate="noReferrals">You don't have any referrals yet</p>
                        <p class="text-xs text-gray-400" data-translate="shareInvite">Share your referral link to invite friends</p>
                    </div>
                    
                    <div class="referral-data hide" id="referralsList">
                        <div class="divide-y divide-gray-100" id="referralsContainer"></div>
                    </div>
                </div>
                
                <div id="withdrawals-tab" class="tab-content hide">
                    <div class="text-center py-8 text-gray-500" id="noWithdrawals">
                        <div class="inline-block p-3 bg-gray-100 rounded-full mb-3">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <p class="text-sm mb-2" data-translate="noWithdrawals">No withdrawal history yet</p>
                        <p class="text-xs text-gray-400" data-translate="startEarning">Start earning by inviting friends</p>
                    </div>
                    
                    <div class="withdrawal-data hide" id="withdrawalsList">
                        <div class="divide-y divide-gray-100" id="withdrawalsContainer"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-5 mb-8 border border-gray-100 shadow-sm">
                <h2 class="text-lg font-bold text-gray-800 mb-3" data-translate="howItWorksReferral">How It Works</h2>
                <div class="space-y-4">
                    <div class="flex items-start">
                        <div class="bg-indigo-100 text-indigo-600 rounded-full h-7 w-7 flex items-center justify-center flex-shrink-0 mr-3">
                            <span class="text-sm font-medium">1</span>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800" data-translate="step1Title">Share Your Link</h3>
                            <p class="text-sm text-gray-600 mt-1" data-translate="step1Desc">Copy your unique referral link and share it with friends</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-indigo-100 text-indigo-600 rounded-full h-7 w-7 flex items-center justify-center flex-shrink-0 mr-3">
                            <span class="text-sm font-medium">2</span>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800" data-translate="step2Title">Friends Make a Purchase</h3>
                            <p class="text-sm text-gray-600 mt-1" data-translate="step2Desc">They get instant access to Premium or Stars</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-indigo-100 text-indigo-600 rounded-full h-7 w-7 flex items-center justify-center flex-shrink-0 mr-3">
                            <span class="text-sm font-medium">3</span>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800" data-translate="step3Title">You Earn Rewards</h3>
                            <p class="text-sm text-gray-600 mt-1" data-translate="step3Desc">Get 0.5 USDT for each successful referral</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-indigo-100 text-indigo-600 rounded-full h-7 w-7 flex items-center justify-center flex-shrink-0 mr-3">
                            <span class="text-sm font-medium">4</span>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800" data-translate="step4Title">Withdraw Earnings</h3>
                            <p class="text-sm text-gray-600 mt-1" data-translate="step4Desc">Transfer funds to your TON wallet when ready</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Popup -->
    <div class="popup" id="withdrawPopup">
        <div class="text-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800 mb-2" data-translate="withdrawTitle">Withdraw Funds</h3>
                <p class="text-sm text-gray-600" data-translate="withdrawDesc">Transfer your earnings to your TON wallet</p>
        </div>

        <form class="withdraw-form" id="withdrawalForm">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="amount">Amount (USDT)</label>
                <input type="number" name="amount" min="1" step="0.01" class="w-full" placeholder="0.00" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="walletAddress">TON Wallet Address</label>
                <input type="text" name="wallet" class="w-full" placeholder="UQ..." required>
            </div>
                          <button type="submit" class="w-full" data-translate="submitWithdrawal">Submit Withdrawal</button>
        </form>
    </div>

<script>
// Initialize Telegram WebApp
if (window.Telegram?.WebApp) {
    const webApp = window.Telegram.WebApp;
    webApp.ready();
    webApp.expand();
    
    // Add fullscreen class to body
    document.body.classList.add('telegram-fullscreen');
    
    console.log('Telegram Mini App mode enabled');
}

const tgWebApp = window.Telegram?.WebApp;
const tgUser = tgWebApp?.initDataUnsafe?.user;
const BASE_API_URL = window.location.origin + '/api';

let currentLanguage = localStorage.getItem('appLanguage') || 'en';
let userId = 'default_user_id';
if (tgUser?.id) {
    userId = tgUser.id.toString();
    console.log('Using Telegram user ID:', userId);
}

// Store referrer information if present, but don't overwrite current user's ID
let referrerUserId = null;
if (tgWebApp?.initData) {
    const urlParams = new URLSearchParams(tgWebApp.initData);
    const startParam = urlParams.get('start');
    if (startParam?.startsWith('ref_')) {
        referrerUserId = startParam.split('ref_')[1];
        console.log('Referrer detected:', referrerUserId);
        // Note: This should be handled separately for referral tracking
        // Don't overwrite the current user's ID with the referrer's ID
    }
}

const state = {
    userId,
    username: tgUser?.username || 'User',
    language: localStorage.getItem('appLanguage') || 'en',
    referralCode: null,
    referralLink: null,
    stats: {
        availableBalance: 0,
        totalEarned: 0,
        referralsCount: 0,
        pendingAmount: 0
    },
    referrals: [],
    withdrawals: []
};

// Initialize UI with default values immediately
document.addEventListener('DOMContentLoaded', () => {
    updateUI();
    applyTranslations();
});
    
// Initialize language
function initLanguage() {
    // Check URL parameter first
    const urlParams = new URLSearchParams(window.location.search);
    const urlLang = urlParams.get('lang');
    
    if (urlLang && ['en', 'ru', 'hi', 'ar'].includes(urlLang)) {
        currentLanguage = urlLang;
        localStorage.setItem('appLanguage', currentLanguage);
    } else {
        currentLanguage = localStorage.getItem('appLanguage') || 'en';
    }
    
    applyTranslations();
}

// Listen for language changes from other pages
window.addEventListener('storage', (e) => {
    if (e.key === 'appLanguage') {
        currentLanguage = e.newValue || 'en';
        applyTranslations();
    }
});

window.addEventListener('languageChanged', () => {
    currentLanguage = localStorage.getItem('appLanguage') || 'en';
    applyTranslations();
});

function init() {
    initLanguage(); 
    setupEventListeners();
    loadReferralData();
    loadWithdrawalHistory();
    setupTelegramSharing();
    
    // Set up auto-refresh for withdrawal status
    setInterval(fetchWithdrawals, 15000); // Refresh every 15 seconds
}

    
 
async function loadReferralData() {
    try {
        console.log('Loading referral data for userId:', state.userId);
        
        // Validate we have a proper user ID
        if (!state.userId || state.userId === 'default_user_id') {
            throw new Error('No valid Telegram user ID available');
        }
        
        const response = await fetch(`${BASE_API_URL}/referral-stats/${state.userId}`, {
            headers: {
                'x-telegram-init-data': window.Telegram?.WebApp?.initData || '',
                'x-telegram-id': state.userId,
                'Content-Type': 'application/json'
            }
        });
        console.log('Response status:', response.status);
        
        if (response.status === 403) {
            throw new Error('Unauthorized access to referral data');
        }
        if (response.status === 404) {
            throw new Error('User not found in system');
        }
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Received data:', data);
        console.log('Stats from API:', data.stats);
        
        if (!data.success) throw new Error(data.error || 'Failed to load referral data');

        state.referrals = data.referrals || [];
        state.stats = {
            availableBalance: parseFloat(data.stats?.availableBalance || 0),
            totalEarned: parseFloat(data.stats?.totalEarned || 0),
            referralsCount: parseInt(data.stats?.referralsCount || 0),
            pendingAmount: parseFloat(data.stats?.pendingAmount || 0)
        };
        
        // Ensure referralsCount is never undefined or null
        if (isNaN(state.stats.referralsCount)) {
            state.stats.referralsCount = 0;
        }
        state.referralLink = data.referralLink || `https://t.me/TgStarStore_bot?start=ref_${state.userId}`;

        console.log('Parsed stats:', state.stats);
        console.log('Updated state:', state);
        updateUI();
        applyTranslations();
    } catch (error) {
        console.error('Error loading referral data:', error);
        // Set default values if API fails
        state.stats = {
            availableBalance: 0,
            totalEarned: 0,
            referralsCount: 0,
            pendingAmount: 0
        };
        state.referralLink = `https://t.me/TgStarStore_bot?start=ref_${state.userId}`;
        updateUI();
        applyTranslations();
        showError('Failed to load referral data');
    }
}

async function loadWithdrawalHistory() {
    try {
        // Validate we have a proper user ID
        if (!state.userId || state.userId === 'default_user_id') {
            console.log('No valid user ID for withdrawal history');
            return;
        }
        
        const response = await fetch(`${BASE_API_URL}/withdrawal-history/${state.userId}`, {
            headers: {
                'x-telegram-init-data': window.Telegram?.WebApp?.initData || '',
                'x-telegram-id': state.userId,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.status === 403) {
            console.error('Unauthorized access to withdrawal history');
            return;
        }
        if (response.status === 404) {
            console.log('User not found for withdrawal history');
            return;
        }
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const data = await response.json();
        if (data.success) {
            state.withdrawals = data.withdrawals || [];
            updateWithdrawalsList();
        }
    } catch (error) {
        console.error('Error loading withdrawal history:', error);
    }
}

function updateUI() {
    console.log('Updating UI with stats:', state.stats);
    
    // Safely update each element
    const availableBalanceEl = document.getElementById('availableBalance');
    const totalEarnedEl = document.getElementById('totalEarned');
    const referralsCountEl = document.getElementById('referralsCount');
    const pendingAmountEl = document.getElementById('pendingAmount');
    const referralLinkDisplayEl = document.getElementById('referralLinkDisplay');
    
    if (availableBalanceEl) availableBalanceEl.textContent = `${state.stats.availableBalance.toFixed(2)} USDT`;
    if (totalEarnedEl) totalEarnedEl.textContent = `${state.stats.totalEarned.toFixed(2)} USDT`;
    if (referralsCountEl) referralsCountEl.textContent = state.stats.referralsCount;
    if (pendingAmountEl) pendingAmountEl.textContent = `${state.stats.pendingAmount.toFixed(2)} USDT`;
    if (referralLinkDisplayEl) referralLinkDisplayEl.textContent = state.referralLink;
    
    updateReferralsList();
    updateWithdrawalsList();
}


function updateReferralsList() {
    const container = document.getElementById('referralsContainer');
    container.innerHTML = '';
    
    if (state.referrals.length === 0) {
        document.getElementById('noReferrals').classList.remove('hide');
        document.getElementById('referralsList').classList.add('hide');
        return;
    }
    
    document.getElementById('noReferrals').classList.add('hide');
    document.getElementById('referralsList').classList.remove('hide');
    
    state.referrals.forEach(referral => {
        const item = document.createElement('div');
        item.className = 'py-3 flex justify-between items-center';
        item.innerHTML = `
            <div>
                <div class="flex items-center">
                    <span class="dot ${referral.status === 'completed' ? 'dot-success' : 'dot-pending'}"></span>
                    <span class="font-medium">${referral.name || referral.userId.substring(0, 8)}</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">${new Date(referral.date).toLocaleDateString()}</div>
            </div>
            <div class="text-right">
                <div class="font-medium text-gray-800">+0.5 USDT</div>
                <div class="text-xs ${referral.status === 'completed' ? 'text-green-500' : 'text-yellow-500'}">${referral.status}</div>
            </div>
        `;
        container.appendChild(item);
    });
}

function formatDate(dateString) {
    try {
        if (!dateString) return '01/01/1960';
        
        
        const date = dateString.$date ? 
            new Date(parseInt(dateString.$date.$numberLong)) : 
            new Date(dateString);
            
        if (isNaN(date.getTime())) return '01/01/1960';
        
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    } catch (e) {
        return '01/01/1960';
    }
}
 
 
async function fetchWithdrawals() {
    try {
        const response = await fetch(`${BASE_API_URL}/withdrawal-history/${state.userId}`, {
            headers: {
                'x-telegram-init-data': window.Telegram?.WebApp?.initData || '',
                'x-telegram-id': state.userId,
                'Content-Type': 'application/json'
            }
        });
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                state.withdrawals = data.withdrawals;
                updateWithdrawalsList();
            }
        }
    } catch (error) {
        console.error('Error fetching withdrawals:', error);
    }
}

function updateWithdrawalsList() {
    const container = document.getElementById('withdrawalsContainer');
    container.innerHTML = '';
    
    if (state.withdrawals.length === 0) {
        document.getElementById('noWithdrawals').classList.remove('hide');
        document.getElementById('withdrawalsList').classList.add('hide');
        return;
    }
    
    document.getElementById('noWithdrawals').classList.add('hide');
    document.getElementById('withdrawalsList').classList.remove('hide');
    
    state.withdrawals.forEach(withdrawal => {
        const statusClass = withdrawal.status === 'completed' ? 'status-completed' : 
                          withdrawal.status === 'declined' ? 'status-declined' : 'status-pending';
        
        const item = document.createElement('div');
        item.className = 'py-3 flex justify-between items-center withdrawal-item';
        item.innerHTML = `
            <div class="flex-1">
                <div class="font-medium text-gray-800">${withdrawal.amount.toFixed(2)} USDT</div>
                <div class="text-xs text-gray-500 mt-1 wallet-address">
                    ${withdrawal.walletAddress.substring(0, 6)}...${withdrawal.walletAddress.slice(-4)}
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm ${statusClass}">
                    ${withdrawal.status}
                </div>
                <div class="text-xs text-gray-400 mt-1">
                    ${formatDate(withdrawal.createdAt)}
                </div>
            </div>
        `;
        container.appendChild(item);
    });
}
 
function setupEventListeners() {
    // load bottom nav
    fetch('bottomnav.html').then(r => r.ok ? r.text() : '').then(html => { 
        document.getElementById('bottomnav-container').innerHTML = html; 
        // Apply translations to bottom nav after loading
        if (typeof TranslationUtils !== 'undefined') {
            TranslationUtils.applyTranslations();
        }
    });
    document.getElementById('copyButton').addEventListener('click', copyReferralLink);
    document.getElementById('withdrawButton').addEventListener('click', showWithdrawPopup);
    document.getElementById('shareFb').addEventListener('click', shareToFacebook);
    document.getElementById('shareTw').addEventListener('click', shareToTwitter);
    document.getElementById('shareWa').addEventListener('click', shareToWhatsApp);
    document.getElementById('shareTg').addEventListener('click', shareViaTelegram);
    
    document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
        const tabName = button.getAttribute('data-tab');
        switchTab(tabName);
    });
});
    
}

// side menu deprecated

function switchTab(tabName) {
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
        btn.classList.toggle('text-gray-800', btn.getAttribute('data-tab') === tabName);
        btn.classList.toggle('text-gray-500', btn.getAttribute('data-tab') !== tabName);
    });
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('hide', content.id !== `${tabName}-tab`);
    });
}

function changeLanguage(language) {
    state.language = language;
    localStorage.setItem('appLanguage', language);
    applyTranslations();
    document.querySelectorAll('.language-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-language') === language);
    });
}

function copyReferralLink() {
    navigator.clipboard.writeText(state.referralLink).then(() => {
        showSuccess('Link copied to clipboard!');
    }).catch(err => {
        showError('Failed to copy link');
    });
}
 
function shareToFacebook() {
    const text = `${TranslationUtils.get('shareTwText') || 'Check out StarStore! Use my referral link to get started:'} ${state.referralLink}`;
    const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(state.referralLink)}&quote=${encodeURIComponent(text)}`;
    window.open(shareUrl, '_blank', 'width=600,height=400');
}

function shareToTwitter() {
    const text = `${TranslationUtils.get('shareTwText') || 'Check out StarStore! Use my referral link to get started:'} ${state.referralLink}`;
    const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
    window.open(shareUrl, '_blank', 'width=600,height=300');
}

function shareToWhatsApp() {
    const text = `${TranslationUtils.get('shareWaText') || 'Check out StarStore! Use my referral link to get started:'} ${state.referralLink}`;
    const shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;
    window.open(shareUrl, '_blank', 'width=600,height=600');
}

function shareViaTelegram() {
    const text = `${TranslationUtils.get('shareTgText') || 'Check out StarStore! Use my referral link to get started:'} ${state.referralLink}`;
    if (window.Telegram?.WebApp?.share) {
        window.Telegram.WebApp.share(text);
    } else {
        const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(state.referralLink)}&text=${encodeURIComponent(text)}`;
        window.open(shareUrl, '_blank', 'width=600,height=600');
    }
}

function isValidTONAddress(address) {
    if (!address || typeof address !== 'string') return false;
    
    // Remove any prefix and trim whitespace
    const cleanAddr = address.replace(/^(ton:\/\/|ton:|TON:|t.me\/|@)/i, '').trim();
    
    // Support different TON address formats
    const tonAddressRegex = /^[0-9A-Za-z_-]{48,}$/;
    
    // Check if it's a valid TON address
    if (tonAddressRegex.test(cleanAddr) && cleanAddr.length >= 48) {
        return true;
    }
    
    // Add support for user-friendly TON DNS addresses
    const tonDnsRegex = /^[a-z0-9][a-z0-9\-_.]+\.(ton|t\.me)$/i;
    if (tonDnsRegex.test(cleanAddr)) {
        return true;
    }
    
    return false;
}

 
async function showWithdrawPopup() {
    try {
        // Refresh in background for recency, but don't block popup showing
        loadReferralData().catch(() => {});
        
        const availableBalance = parseFloat(state.stats?.availableBalance || 0);
        const activeReferralsCount = Math.floor(availableBalance / 0.5);

        if (availableBalance < 0.5) {
            await Swal.fire({
                title: TranslationUtils.get('insufficientBalanceTitle') || 'Insufficient Balance',
                html: `<div class="text-center">
                    <p>${TranslationUtils.get('insufficientBalanceText') || 'You need at least 1 completed referral (0.5 USDT) to withdraw.'}</p>
                    <p class="mt-2">
                        <span class="font-semibold">${TranslationUtils.get('yourBalance') || 'Your balance:'}</span> 
                        ${availableBalance.toFixed(2)} USDT (${activeReferralsCount} ${TranslationUtils.get('referrals') || 'Referrals'})
                    </p>
                </div>`,
                icon: 'error',
                confirmButtonText: TranslationUtils.get('ok') || 'OK'
            });
            return;
        }

        const { value: formValues } = await Swal.fire({
            title: TranslationUtils.get('withdraw') || 'Withdraw',
            html: `
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">${TranslationUtils.get('amount') || 'Amount'} (USDT)</label>
                    <input type="number" id="withdrawAmount" 
                           min="0.5" max="${availableBalance}" 
                           inputmode="decimal" step="0.01" value="${Math.min(0.5, availableBalance).toFixed(2)}"
                           class="w-full p-2 border rounded" required>
                    <div class="flex items-center justify-between mt-1">
                        <p class="text-xs text-gray-500">${TranslationUtils.get('availableBalance') || 'Available Balance'}: ${availableBalance.toFixed(2)} USDT (${activeReferralsCount} ${TranslationUtils.get('referrals') || 'Referrals'})</p>
                        <button type="button" id="withdrawAllBtn" class="text-xs text-indigo-600 hover:underline font-medium">${TranslationUtils.get('withdraw') || 'Withdraw'} ${TranslationUtils.get('all') || 'All'}</button>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">${TranslationUtils.get('walletAddress') || 'TON Wallet Address'}</label>
                    <input type="text" id="withdrawWallet" 
                           class="w-full p-2 border rounded" 
                           placeholder="EQ..." required>
                </div>`,
            focusConfirm: false,
            returnFocus: false,
            showCancelButton: true,
            confirmButtonText: TranslationUtils.get('withdraw') || 'Withdraw',
            cancelButtonText: TranslationUtils.get('cancel') || 'Cancel',
            showClass: {
                popup: 'animate__animated animate__fadeIn animate__faster'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOut animate__faster'
            },
            didOpen: () => {
                const allBtn = document.getElementById('withdrawAllBtn');
                const amountInput = document.getElementById('withdrawAmount');
                if (allBtn && amountInput) {
                    allBtn.addEventListener('click', () => {
                        amountInput.value = `${availableBalance.toFixed(2)}`;
                    });
                }
            },
            preConfirm: () => {
                const amountRaw = document.getElementById('withdrawAmount').value;
                const amount = parseFloat(amountRaw);
                const wallet = document.getElementById('withdrawWallet').value.trim();

                if (!amount || amount < 0.5) {
                    Swal.showValidationMessage(TranslationUtils.get('minWithdraw') || 'Minimum withdrawal is 0.5 USDT');
                    return false;
                }

                if (amount > availableBalance) {
                    Swal.showValidationMessage(`${TranslationUtils.get('maxWithdraw') || 'Maximum withdrawal is'} ${availableBalance.toFixed(2)} USDT`);
                    return false;
                }

                // Enforce 0.5 USDT increments
                const isHalfIncrement = Math.abs((amount * 100) % 50) < 1e-6;
                if (!isHalfIncrement) {
                    Swal.showValidationMessage('Amount must be in increments of 0.5 USDT');
                    return false;
                }

                if (!isValidTONAddress(wallet)) {
                    Swal.showValidationMessage(TranslationUtils.get('invalidWallet') || 'Invalid TON wallet address');
                    return false;
                }

                return { amount, walletAddress: wallet };
            }
        });

        if (formValues) {
            const success = await submitWithdrawal(formValues);
            if (success) {
                await Swal.fire({
                    title: 'Success!',
                    text: `Withdrawal of ${formValues.amount} USDT requested`,
                    icon: 'success'
                });
                await loadReferralData();
            }
        }
    } catch (error) {
        await Swal.fire({
            title: 'Error',
            text: error.message || 'Withdrawal failed',
            icon: 'error'
        });
    }
}


async function submitWithdrawal({ amount, walletAddress }) {
    try {
        Swal.showLoading();
        
        const response = await fetch(`${BASE_API_URL}/referral-withdrawals`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                userId: state.userId,
                amount: parseFloat(amount),
                walletAddress: walletAddress
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || TranslationUtils.get('withdrawError') || 'Withdrawal failed');
        }

        // Refresh withdrawal data from server
        await fetchWithdrawals();
        
        // Update available balance
        state.stats.availableBalance -= parseFloat(amount);
        updateUI();
        
        return true;
    } catch (error) {
        await Swal.fire({
            title: TranslationUtils.get('error') || 'Error',
            text: error.message || TranslationUtils.get('withdrawError') || 'Withdrawal failed. Please try again.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
        return false;
    } finally {
        Swal.hideLoading();
    }
}

function showSuccess(message) {
    Swal.fire({
        position: 'top',
        icon: 'success',
        title: message,
        showConfirmButton: false,
        timer: 1500
    });
}

function showError(message) {
    Swal.fire({
        position: 'top',
        icon: 'error',
        title: message,
        showConfirmButton: false,
        timer: 1500
    });
}

// Initialize translations
if (typeof TranslationUtils !== 'undefined') {
    TranslationUtils.init();
}

function applyTranslations() {
    if (typeof TranslationUtils !== 'undefined') {
        TranslationUtils.applyTranslations();
    }
}

init();
</script>
 
</body>
</html>
