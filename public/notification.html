
<div class="notification-container hidden" id="notificationContainer">
  <div class="notification-header">
    <h3>Notifications</h3>
    <div class="notification-actions">
      <button id="markAllRead">Mark All Read</button>
      <button id="notificationClose">Ã—</button>
    </div>
  </div>
  
  <div class="notification-loading hidden" id="notificationLoading">
    Loading...
  </div>
  
  <div class="notification-list" id="notificationList">
    <div class="notification-empty" id="notificationEmpty">
      No new notifications
    </div>
  </div>
  
  <div class="notification-footer">
    <button id="viewAllNotifications">View All</button>
  </div>
</div>

<style>
  .notification-container {
    position: fixed;
    top: 60px;
    right: 20px;
    width: 300px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 1000;
    font-family: sans-serif;
  }
  
  .notification-container.hidden {
    display: none;
  }
  
  .notification-header {
    padding: 12px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .notification-list {
    max-height: 400px;
    overflow-y: auto;
    padding: 8px;
  }
  
  .notification-item {
    padding: 10px;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
  }
  
  .notification-item.unread {
    background-color: #f8f9fa;
  }
  
  .notification-empty {
    padding: 20px;
    text-align: center;
    color: #666;
  }
  
  .notification-loading {
    padding: 20px;
    text-align: center;
  }
  
  .notification-footer {
    padding: 10px;
    border-top: 1px solid #eee;
    text-align: center;
  }
  
  button {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
  }
</style>

<script>
class NotificationSystem {
  constructor() {
    this.container = document.getElementById('notificationContainer');
    this.listElement = document.getElementById('notificationList');
    this.emptyState = document.getElementById('notificationEmpty');
    this.loadingState = document.getElementById('notificationLoading');
    this.badgeElement = document.getElementById('notificationBadge');
    
    this.notifications = [];
    this.init();
  }
  
  init() {
    document.getElementById('notificationClose').addEventListener('click', () => this.hide());
    document.getElementById('markAllRead').addEventListener('click', () => this.markAllAsRead());
    document.getElementById('viewAllNotifications').addEventListener('click', () => this.viewAll());
    
    this.fetchNotifications();
    setInterval(() => this.fetchNotifications(), 30000);
  }

  async fetchNotifications() {
    try {
      this.showLoading();
      
      const params = new URLSearchParams();
      if (window.currentUser?.id) params.append('userId', window.currentUser.id);
      else if (window.currentWalletAddress) params.append('userId', window.currentWalletAddress);
      else params.append('userId', 'anonymous');
      
      const response = await fetch(`/api/notifications?${params}`);
      if (!response.ok) throw new Error('Failed to fetch');
      
      const notifications = await response.json();
      this.notifications = notifications.map(n => ({
        id: n.id,
        title: n.title || 'Notification',
        message: n.message,
        timestamp: n.timestamp,
        read: n.read || false
      }));
      
      this.renderNotifications();
      this.updateBadge();
    } catch (error) {
      console.error('Fetch error:', error);
      this.showEmptyState('Failed to load');
    } finally {
      this.hideLoading();
    }
  }
  
  renderNotifications() {
    this.listElement.innerHTML = '';
    
    if (this.notifications.length === 0) {
      this.showEmptyState();
      return;
    }
    
    this.notifications.forEach(notification => {
      const item = document.createElement('div');
      item.className = `notification-item ${notification.read ? '' : 'unread'}`;
      item.innerHTML = `
        <div><strong>${notification.title}</strong></div>
        <div>${notification.message}</div>
        <small>${new Date(notification.timestamp).toLocaleTimeString()}</small>
      `;
      item.addEventListener('click', () => this.handleNotificationClick(notification));
      this.listElement.appendChild(item);
    });
  }
  
  async handleNotificationClick(notification) {
    if (!notification.read) {
      await fetch(`/api/notifications/${notification.id}/read`, { method: 'POST' });
      notification.read = true;
      this.renderNotifications();
      this.updateBadge();
    }
  }
  
  async markAllAsRead() {
    const body = {};
    if (window.currentUser?.id) body.userId = window.currentUser.id;
    else if (window.currentWalletAddress) body.userId = window.currentWalletAddress;
    
    await fetch('/api/notifications/mark-all-read', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    
    this.notifications.forEach(n => n.read = true);
    this.renderNotifications();
    this.updateBadge();
  }
  
  updateBadge() {
    if (!this.badgeElement) return;
    const unread = this.notifications.filter(n => !n.read).length;
    this.badgeElement.textContent = unread > 0 ? unread : '';
    this.badgeElement.style.display = unread > 0 ? 'block' : 'none';
  }
  
  showLoading() {
    this.loadingState.classList.remove('hidden');
    this.listElement.classList.add('hidden');
  }
  
  hideLoading() {
    this.loadingState.classList.add('hidden');
    this.listElement.classList.remove('hidden');
  }
  
  showEmptyState(message = 'No notifications') {
    this.emptyState.textContent = message;
    this.emptyState.classList.remove('hidden');
    this.listElement.classList.add('hidden');
  }
  
  show() {
    this.container.classList.remove('hidden');
    this.fetchNotifications();
  }
  
  hide() {
    this.container.classList.add('hidden');
  }
  
  toggle() {
    this.container.classList.contains('hidden') ? this.show() : this.hide();
  }
  
  viewAll() {
    window.location.href = '/notifications';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  window.notificationSystem = new NotificationSystem();
  
  document.getElementById('notificationButton').addEventListener('click', (e) => {
    e.stopPropagation();
    window.notificationSystem.toggle();
  });
});
</script>
