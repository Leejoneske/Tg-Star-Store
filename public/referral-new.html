<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, shrink-to-fit=no, viewport-fit=cover">
    <title>Referral Program - StarStore</title>
    <link rel="canonical" href="https://starstore.site/referral">
    <meta name="description" content="Earn 0.5 USDT per successful referral. Share your unique link and start earning today!">
    <meta property="og:title" content="StarStore Referral Program">
    <meta property="og:description" content="Earn 0.5 USDT per successful referral. Share your unique link and start earning today!">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/translations.js?v=4"></script>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="/css/theme-additional.css?v=7">
    <script src="/js/loading.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            background: #f5f5f5;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
            padding-bottom: 80px;
        }
        .telegram-fullscreen .app-container {
            max-width: 100%;
            width: 100%;
            margin: 0;
            box-shadow: none;
            border-radius: 0;
        }
        .clean-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }
        .stat-box {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-top: 8px;
        }
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .hero-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-radius: 16px;
            padding: 32px 20px;
            margin: 12px;
            text-align: center;
        }
        .hero-gradient h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px 0;
        }
        .hero-gradient p {
            font-size: 14px;
            opacity: 0.9;
            margin: 0;
        }
        .btn-primary {
            background: #4f46e5;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            font-size: 14px;
        }
        .btn-primary:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: white;
            color: #4f46e5;
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid #4f46e5;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            font-size: 14px;
        }
        .btn-secondary:active {
            transform: scale(0.98);
        }
        .link-display {
            background: #f3f4f6;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 16px;
            font-family: monospace;
            font-size: 13px;
            word-break: break-all;
            color: #1f2937;
            margin-bottom: 12px;
        }
        .copy-btn {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            font-weight: 600;
            color: #4f46e5;
        }
        .copy-btn:active {
            transform: scale(0.95);
        }
        .share-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .share-btn {
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .share-btn:active {
            transform: scale(0.95);
        }
        .referral-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #10b981;
        }
        .referral-item.pending {
            border-left-color: #f59e0b;
        }
        .referral-info h3 {
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 4px 0;
            font-size: 14px;
        }
        .referral-info p {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }
        .referral-earning {
            text-align: right;
        }
        .referral-earning .amount {
            font-weight: 700;
            color: #10b981;
            font-size: 16px;
            margin-bottom: 4px;
        }
        .referral-earning .status {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #6b7280;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 16px;
            margin: 12px;
        }
        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        .empty-state h3 {
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 8px 0;
        }
        .empty-state p {
            color: #6b7280;
            font-size: 14px;
            margin: 0;
        }
        .tab-container {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e5e7eb;
            background: white;
            padding: 0 12px;
        }
        .tab {
            padding: 16px 12px;
            font-weight: 600;
            font-size: 14px;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
            bottom: -2px;
        }
        .tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        .how-it-works {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .step {
            background: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        .step-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            margin: 0 auto 12px;
        }
        .step h4 {
            font-weight: 600;
            color: #1f2937;
            font-size: 13px;
            margin: 0 0 6px 0;
        }
        .step p {
            font-size: 11px;
            color: #6b7280;
            margin: 0;
        }
        .toggle-btn {
            background: #e5e7eb;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-btn.active {
            background: #4f46e5;
            color: white;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="bottomnav-container"></div>

        <!-- Hero Section -->
        <div class="hero-gradient">
            <h1 data-translate="referralTitle">Earn Together</h1>
            <p data-translate="referralSubtitle">Invite friends and get rewarded</p>
        </div>

        <!-- Stats Grid -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 12px;">
            <div class="stat-box">
                <div class="stat-label" data-translate="availableBalance">Available</div>
                <div class="stat-value" id="availableBalance">0.00</div>
                <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">USDT</div>
            </div>
            <div class="stat-box">
                <div class="stat-label" data-translate="totalEarned">Total Earned</div>
                <div class="stat-value" id="totalEarned">0.00</div>
                <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">USDT</div>
            </div>
            <div class="stat-box">
                <div class="stat-label" data-translate="referrals">Referrals</div>
                <div class="stat-value" id="referralsCount">0</div>
                <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;" data-translate="active">Active</div>
            </div>
            <div class="stat-box">
                <div class="stat-label" data-translate="withdrawn">Withdrawn</div>
                <div class="stat-value" id="pendingAmount">0.00</div>
                <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">USDT</div>
            </div>
        </div>

        <!-- Referral Link Section -->
        <div class="clean-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h2 style="font-size: 16px; font-weight: 700; color: #1f2937; margin: 0;" data-translate="yourLink">Your Link</h2>
                <button class="toggle-btn active" id="toggleReferralFormat" data-translate="new">New</button>
            </div>
            
            <div class="link-display" id="referralLinkDisplay">
                <span data-translate="loading">Loading...</span>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button id="copyButton" class="copy-btn" style="flex: 1;" data-translate="copy">üìã Copy</button>
                <button id="shareButton" class="btn-primary" style="flex: 1; background: #4f46e5;" data-translate="share">Share</button>
            </div>
            
            <!-- Legacy link toggle -->
            <div id="legacyLinkSection" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                <p style="font-size: 11px; color: #6b7280; margin: 0 0 8px 0; font-weight: 600;" data-translate="legacy">Legacy Link</p>
                <div class="link-display" id="legacyReferralLinkDisplay" style="font-size: 11px;">
                    <span data-translate="loading">Loading...</span>
                </div>
                <button id="copyLegacyButton" class="copy-btn" style="width: 100%; margin-top: 8px;" data-translate="copy">üìã Copy</button>
            </div>
        </div>

        <!-- Referral List Tabs -->
        <div class="tab-container">
            <div class="tab active" data-tab="referred" data-translate="myReferrals">My Referrals</div>
            <div class="tab" data-tab="history" data-translate="history">History</div>
        </div>

        <!-- Referred Tab -->
        <div id="referred-tab" class="tab-content" style="padding: 12px;">
            <div id="noReferrals" class="empty-state">
                <div class="empty-icon">üë•</div>
                <h3 data-translate="noReferrals">No Referrals Yet</h3>
                <p data-translate="referralEmptyHint">Share your link above to get started</p>
            </div>
            <div id="referralsList"></div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content" style="display: none; padding: 12px;">
            <div id="noWithdrawals" class="empty-state">
                <div class="empty-icon">üí∞</div>
                <h3 data-translate="noWithdrawals">No History</h3>
                <p data-translate="noWithdrawalsHint">Your withdrawal history will appear here</p>
            </div>
            <div id="withdrawalsList"></div>
        </div>

        <!-- Action Buttons -->
        <div style="padding: 12px; display: flex; gap: 12px;">
            <button id="withdrawButton" class="btn-primary" data-translate="withdraw">Withdraw Earnings</button>
        </div>

        <!-- How It Works -->
        <div style="padding: 0 12px 12px;">
            <h3 style="font-weight: 700; color: #1f2937; margin: 0 0 16px 0; font-size: 16px;" data-translate="howItWorks">How It Works</h3>
            <div class="how-it-works">
                <div class="step">
                    <div class="step-icon">1</div>
                    <h4 data-translate="step1Title">Share Link</h4>
                    <p data-translate="step1Desc">Copy & share your referral link</p>
                </div>
                <div class="step">
                    <div class="step-icon">2</div>
                    <h4 data-translate="step2Title">100+ Stars</h4>
                    <p data-translate="step2Desc">Friends purchase 100+ stars</p>
                </div>
                <div class="step">
                    <div class="step-icon">3</div>
                    <h4 data-translate="step3Title">Earn 0.5 USDT</h4>
                    <p data-translate="step3Desc">Instant reward per referral</p>
                </div>
                <div class="step">
                    <div class="step-icon">4</div>
                    <h4 data-translate="step4Title">Withdraw</h4>
                    <p data-translate="step4Desc">Cash out to TON wallet</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize app
        if (window.Telegram?.WebApp) {
            const webApp = window.Telegram.WebApp;
            webApp.ready();
            webApp.expand();
            document.body.classList.add('telegram-fullscreen');
        }

        const tgWebApp = window.Telegram?.WebApp;
        const tgUser = tgWebApp?.initDataUnsafe?.user;
        const BASE_API_URL = window.location.origin + '/api';
        let userId = tgUser?.id?.toString() || 'default_user_id';

        const state = {
            userId,
            referralLink: null,
            newReferralLink: null,
            showNewReferral: true,
            stats: { availableBalance: 0, totalEarned: 0, referralsCount: 0, pendingAmount: 0 },
            referrals: [],
            withdrawals: []
        };

        // Load data on init
        document.addEventListener('DOMContentLoaded', async () => {
            loadBottomNav();
            await loadReferralData();
            setupEventListeners();
            applyTranslations();
        });

        async function loadBottomNav() {
            try {
                const res = await fetch('/bottomnav.html');
                if (res.ok) {
                    document.getElementById('bottomnav-container').innerHTML = await res.text();
                }
            } catch (e) {
                console.error('Failed to load bottom nav');
            }
        }

        async function loadReferralData() {
            try {
                const response = await fetch(`${BASE_API_URL}/referral-stats/${state.userId}`, {
                    headers: {
                        'x-telegram-init-data': tgWebApp?.initData || '',
                        'x-telegram-id': state.userId
                    }
                });

                if (!response.ok) throw new Error('Failed to load data');

                const data = await response.json();
                if (data.success) {
                    state.referralLink = data.referralLink;
                    state.newReferralLink = data.newReferralLink || data.referralLink;
                    state.stats = {
                        availableBalance: parseFloat(data.stats?.availableBalance || 0),
                        totalEarned: parseFloat(data.stats?.totalEarned || 0),
                        referralsCount: parseInt(data.stats?.referralsCount || 0),
                        pendingAmount: parseFloat(data.stats?.pendingAmount || 0)
                    };
                    state.referrals = data.referrals || [];
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('availableBalance').textContent = state.stats.availableBalance.toFixed(2);
            document.getElementById('totalEarned').textContent = state.stats.totalEarned.toFixed(2);
            document.getElementById('referralsCount').textContent = state.stats.referralsCount;
            document.getElementById('pendingAmount').textContent = state.stats.pendingAmount.toFixed(2);
            
            updateReferralLinkDisplay();
            updateReferralsList();
        }

        function updateReferralLinkDisplay() {
            const linkEl = document.getElementById('referralLinkDisplay');
            const legacySection = document.getElementById('legacyLinkSection');
            const legacyLinkEl = document.getElementById('legacyReferralLinkDisplay');
            
            if (state.showNewReferral) {
                linkEl.textContent = state.newReferralLink || state.referralLink;
                legacySection.style.display = 'none';
            } else {
                linkEl.textContent = state.referralLink;
                legacyLinkEl.textContent = state.referralLink;
                legacySection.style.display = 'block';
            }
        }

        function updateReferralsList() {
            const container = document.getElementById('referralsList');
            const noReferrals = document.getElementById('noReferrals');
            
            if (!state.referrals || state.referrals.length === 0) {
                container.innerHTML = '';
                noReferrals.style.display = 'block';
                return;
            }
            
            noReferrals.style.display = 'none';
            container.innerHTML = state.referrals.map(ref => `
                <div class="referral-item ${ref.status === 'pending' ? 'pending' : ''}">
                    <div class="referral-info">
                        <h3>${ref.name || 'User #' + ref.userId.substring(0, 6)}</h3>
                        <p>${new Date(ref.date).toLocaleDateString()}</p>
                    </div>
                    <div class="referral-earning">
                        <div class="amount">+0.5</div>
                        <div class="status">${ref.status}</div>
                    </div>
                </div>
            `).join('');
        }

        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                    
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId + '-tab').style.display = 'block';
                });
            });

            // Referral link toggle
            document.getElementById('toggleReferralFormat').addEventListener('click', function() {
                state.showNewReferral = !state.showNewReferral;
                this.textContent = state.showNewReferral ? '‚ùå Legacy' : '‚úì New';
                this.classList.toggle('active');
                updateReferralLinkDisplay();
            });

            // Copy buttons
            document.getElementById('copyButton').addEventListener('click', () => {
                const link = state.showNewReferral ? state.newReferralLink : state.referralLink;
                navigator.clipboard.writeText(link).then(() => {
                    showSuccess('Link copied!');
                });
            });

            document.getElementById('copyLegacyButton')?.addEventListener('click', () => {
                navigator.clipboard.writeText(state.referralLink).then(() => {
                    showSuccess('Link copied!');
                });
            });

            // Share button
            document.getElementById('shareButton').addEventListener('click', () => {
                const link = state.showNewReferral ? state.newReferralLink : state.referralLink;
                const text = `Check out StarStore! Earn 0.5 USDT per referral. ${link}`;
                
                if (navigator.share) {
                    navigator.share({ title: 'StarStore', text });
                } else {
                    Swal.fire({
                        title: 'Share Link',
                        html: `
                            <button style="width: 100%; padding: 10px; margin: 5px 0; background: #1f2937; color: white; border: none; border-radius: 8px;" onclick="window.open('https://t.me/share/url?url=${encodeURIComponent(link)}')">üì± Telegram</button>
                            <button style="width: 100%; padding: 10px; margin: 5px 0; background: #25d366; color: white; border: none; border-radius: 8px;" onclick="window.open('https://api.whatsapp.com/send?text=${encodeURIComponent(text)}')">üí¨ WhatsApp</button>
                            <button style="width: 100%; padding: 10px; margin: 5px 0; background: #1da1f2; color: white; border: none; border-radius: 8px;" onclick="window.open('https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}')">ùïè Twitter</button>
                        `,
                        showConfirmButton: false
                    });
                }
            });

            // Withdraw button
            document.getElementById('withdrawButton').addEventListener('click', showWithdrawPopup);
        }

        async function showWithdrawPopup() {
            const available = state.stats.availableBalance;
            if (available < 0.5) {
                Swal.fire('Insufficient Balance', `You need at least 0.5 USDT to withdraw (You have: ${available.toFixed(2)} USDT)`, 'warning');
                return;
            }

            const { value: formValues } = await Swal.fire({
                title: 'Withdraw Earnings',
                html: `
                    <input type="number" id="amount" placeholder="Amount USDT" max="${available}" min="0.5" step="0.5" value="0.5" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px;">
                    <input type="text" id="wallet" placeholder="TON Wallet (EQ...)" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px;">
                    <p style="font-size: 12px; color: #666;">Available: ${available.toFixed(2)} USDT</p>
                `,
                showCancelButton: true,
                confirmButtonText: 'Withdraw',
                preConfirm: () => {
                    const amount = document.getElementById('amount').value;
                    const wallet = document.getElementById('wallet').value;
                    if (!amount || !wallet) {
                        Swal.showValidationMessage('Please fill in all fields');
                        return false;
                    }
                    return { amount: parseFloat(amount), walletAddress: wallet };
                }
            });

            if (formValues) {
                try {
                    const res = await fetch(`${BASE_API_URL}/referral-withdrawals`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: state.userId, ...formValues })
                    });
                    if (res.ok) {
                        showSuccess('Withdrawal requested!');
                        await loadReferralData();
                    }
                } catch (e) {
                    Swal.fire('Error', 'Withdrawal failed', 'error');
                }
            }
        }

        function showSuccess(msg) {
            Swal.fire({ position: 'top', icon: 'success', title: msg, showConfirmButton: false, timer: 1500 });
        }

        function applyTranslations() {
            if (typeof TranslationUtils !== 'undefined') {
                TranslationUtils.applyTranslations();
            }
        }
    </script>
    <script src="/js/version-display.js"></script>
</body>
</html>
